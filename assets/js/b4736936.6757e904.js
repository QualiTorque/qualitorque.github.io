"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([[84],{3905:function(e,t,r){r.d(t,{Zo:function(){return u},kt:function(){return d}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function c(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),l=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},u=function(e){var t=l(e.components);return n.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),m=l(r),d=a,h=m["".concat(s,".").concat(d)]||m[d]||p[d]||o;return r?n.createElement(h,i(i({ref:t},u),{},{components:r})):n.createElement(h,i({ref:t},u))}));function d(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=m;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,i[1]=c;for(var l=2;l<o;l++)i[l]=r[l];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},1372:function(e,t,r){r.r(t),r.d(t,{assets:function(){return u},contentTitle:function(){return s},default:function(){return d},frontMatter:function(){return c},metadata:function(){return l},toc:function(){return p}});var n=r(7462),a=r(3366),o=(r(7294),r(3905)),i=["components"],c={sidebar_position:7,title:"Service Account Configuration for AWS"},s=void 0,l={unversionedId:"blueprint-designer-guide/service-accounts-for-aws",id:"blueprint-designer-guide/service-accounts-for-aws",title:"Service Account Configuration for AWS",description:"If you're using an EKS cluster as your execution host, and you want to deploy resources to an AWS account, you can use service account to do the authentication and permissions between the pod and the AWS account where the resources will be created. This is done by connecting a service account, which contains these permissions, to the container. The permissions are defined in an IAM role that needs to be associated to the service account.",source:"@site/docs/blueprint-designer-guide/service-accounts-for-aws.md",sourceDirName:"blueprint-designer-guide",slug:"/blueprint-designer-guide/service-accounts-for-aws",permalink:"/blueprint-designer-guide/service-accounts-for-aws",editUrl:"https://github.com/QualiTorque/torque-docs/tree/master/docs/blueprint-designer-guide/service-accounts-for-aws.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7,title:"Service Account Configuration for AWS"},sidebar:"torqueSidebar",previous:{title:"Service Accounts",permalink:"/blueprint-designer-guide/Service Accounts"},next:{title:"Blueprint Policies",permalink:"/blueprint-designer-guide/Policies"}},u={},p=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Associate your cluster to the AWS account",id:"associate-your-cluster-to-the-aws-account",level:2},{value:"Create an IAM role for the service account with the required policy",id:"create-an-iam-role-for-the-service-account-with-the-required-policy",level:2},{value:"Create a service account in the cluster\u2019s namespace",id:"create-a-service-account-in-the-clusters-namespace",level:2}],m={toc:p};function d(e){var t=e.components,r=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,n.Z)({},m,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"If you're using an EKS cluster as your execution host, and you want to deploy resources to an AWS account, you can use service account to do the authentication and permissions between the pod and the AWS account where the resources will be created. This is done by connecting a service account, which contains these permissions, to the container. The permissions are defined in an IAM role that needs to be associated to the service account."),(0,o.kt)("p",null,"The basic process is as follows:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#associate-your-cluster-to-the-aws-account"},"Associate your cluster to the AWS account")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#create-an-iam-role-for-the-service-account-with-the-required-policy"},"Create an IAM role for the service account with the required policy")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#create-a-service-account-in-the-clusters-namespace"},"Create a service account in the cluster\u2019s namespace"))),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"IAM OIDC provider on the cluster\u2019s account, to recognize the cluster on the account"),(0,o.kt)("li",{parentName:"ul"},"kubectl on the cluster"),(0,o.kt)("li",{parentName:"ul"},"AWS CLI on your computer")),(0,o.kt)("h2",{id:"associate-your-cluster-to-the-aws-account"},"Associate your cluster to the AWS account"),(0,o.kt)("p",null,"Make sure to perform the following steps on every AWS account in which the cluster will perform actions."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"To associate the cluster to the account"),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"In AWS CLI, find the cluster\u2019s OIDC provider by running:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},'aws eks describe-cluster --name my-cluster --query "cluster.identity.oidc.issuer" --output text\n')),(0,o.kt)("p",{parentName:"li"},"Where ",(0,o.kt)("strong",{parentName:"p"},"my-cluster")," is the name of the cluster."),(0,o.kt)("p",{parentName:"li"},"The output looks something like this:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"https://oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE\n")),(0,o.kt)("p",{parentName:"li"},"Where ",(0,o.kt)("strong",{parentName:"p"},"EXAMPLED539D4633E53DE1B71EXAMPLE")," is the cluster's OIDC provider")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"On the account to be used by the cluster, list an IAM OIDC provider in the account that is associated to the cluster\u2019s OIDC provider:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"aws iam list-open-id-connect-providers | grep my-cluster-oidc-provider\n")),(0,o.kt)("p",{parentName:"li"},"The IAM OIDC provider is displayed:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},'"Arn": "arn:aws:iam::111122223333:oidc-provider/oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE"\n'))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"If the IAM OIDC provider is nonexistent, do the following to create it:"),(0,o.kt)("p",{parentName:"li"},"a.\tInstall ",(0,o.kt)("strong",{parentName:"p"},"eksctl")," on your computer."),(0,o.kt)("p",{parentName:"li"},"b.\tRun the following to create the IAM OIDC provider and associate it to your cluster:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"eksctl utils associate-iam-oidc-provider --cluster my-cluster \u2013approve\n")),(0,o.kt)("p",{parentName:"li"},"c.\tIn AWS CLI, run the following to get the IAM OIDC provider you created:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"aws iam list-open-id-connect-providers | grep my-cluster-oidc-provider\n")))),(0,o.kt)("h2",{id:"create-an-iam-role-for-the-service-account-with-the-required-policy"},"Create an IAM role for the service account with the required policy"),(0,o.kt)("p",null,"As we explained before, the service account delegates permissions to the container to perform the Terraform actions. The permissions are defined as a policy in an IAM role that is associated to the service account.\nPerform these steps on every account that will be used by your cluster."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Prerequisites")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"IAM policy with the desired permissions")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"To create the IAM role for the service account"),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"In your AWS Console, go to ",(0,o.kt)("strong",{parentName:"li"},"IAM > Role"),"."),(0,o.kt)("li",{parentName:"ol"},"Click ",(0,o.kt)("strong",{parentName:"li"},"Create role"),", select ",(0,o.kt)("strong",{parentName:"li"},"Web identity"),"."),(0,o.kt)("li",{parentName:"ol"},"From the ",(0,o.kt)("strong",{parentName:"li"},"Identity")," provider dropdown list, select your cluster\u2019s OIDC provider."),(0,o.kt)("li",{parentName:"ol"},"From the ",(0,o.kt)("strong",{parentName:"li"},"Audience")," dropdown list, select ",(0,o.kt)("strong",{parentName:"li"},"sts.amazonaws.com"),"."),(0,o.kt)("li",{parentName:"ol"},"Click ",(0,o.kt)("strong",{parentName:"li"},"Next"),"."),(0,o.kt)("li",{parentName:"ol"},"Select the ",(0,o.kt)("strong",{parentName:"li"},"IAM policy")," you wish to associate to the IAM role, and click ",(0,o.kt)("strong",{parentName:"li"},"Next"),"."),(0,o.kt)("li",{parentName:"ol"},"Specify a ",(0,o.kt)("strong",{parentName:"li"},"Role name"),"."),(0,o.kt)("li",{parentName:"ol"},"Scroll down and click ",(0,o.kt)("strong",{parentName:"li"},"Create role"),"."),(0,o.kt)("li",{parentName:"ol"},"Copy the ARN for this role. You will need in the next step.")),(0,o.kt)("h2",{id:"create-a-service-account-in-the-clusters-namespace"},"Create a service account in the cluster\u2019s namespace"),(0,o.kt)("p",null,"Create the service account and associate its IAM role to the IAM role you just created."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"To create the service account"),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Save the following as an ",(0,o.kt)("strong",{parentName:"li"},"SA.yaml")," file. ",(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  annotations:\n    eks.amazonaws.com/role-arn: <enter your role arn here>\n  name: <enter the service account name here>\n  namespace: <enter the namespace name here>  \n"))),(0,o.kt)("li",{parentName:"ol"},"From AWS CLI, run the following command:",(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"kubectl apply -f SA.yaml\n")),"You're done. All that's left to do is specify the service account name in the blueprint YAML. For details, see ",(0,o.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/Service%20Accounts"},"Service Accounts"),".")))}d.isMDXComponent=!0}}]);