"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([[3208],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>g});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=u(n),m=a,g=p["".concat(s,".").concat(m)]||p[m]||d[m]||o;return n?r.createElement(g,i(i({ref:t},c),{},{components:n})):r.createElement(g,i({ref:t},c))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[p]="string"==typeof e?e:a,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},7595:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>u});var r=n(7462),a=(n(7294),n(3905));const o={sidebar_position:8,title:"The CloudFormation Grain"},i=void 0,l={unversionedId:"blueprint-designer-guide/blueprints/cloudformation-grain",id:"blueprint-designer-guide/blueprints/cloudformation-grain",title:"The CloudFormation Grain",description:"The CloudFormation grain represents Torque's native support for AWS CloudFormation templates. Torque enables designers to utilize CloudFormation features for orchestrating both self-developed and community-driven CloudFormation modules in a consistent manner, making them accessible as reusable building blocks. For a complete YAML blueprint example, refer to Example 2: Webgame on S3 (using CloudFormation and Terraform).",source:"@site/docs/blueprint-designer-guide/blueprints/cloudformation-grain.md",sourceDirName:"blueprint-designer-guide/blueprints",slug:"/blueprint-designer-guide/blueprints/cloudformation-grain",permalink:"/blueprint-designer-guide/blueprints/cloudformation-grain",editUrl:"https://github.com/QualiTorque/torque-docs/tree/master/docs/blueprint-designer-guide/blueprints/cloudformation-grain.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{sidebar_position:8,title:"The CloudFormation Grain"},sidebar:"torqueSidebar",previous:{title:"The CDK Grain",permalink:"/blueprint-designer-guide/blueprints/cdk-grain"},next:{title:"The CloudShell Grain",permalink:"/blueprint-designer-guide/blueprints/cloudshell-grain"}},s={},u=[{value:"region",id:"region",level:3},{value:"source",id:"source",level:3},{value:"agent",id:"agent",level:3},{value:"authentication",id:"authentication",level:3},{value:"Template-Storage Configuration",id:"template-storage-configuration",level:3},{value:"inputs\u200b",id:"inputs",level:3},{value:"tags\u200b",id:"tags",level:3},{value:"outputs\u200b",id:"outputs",level:3},{value:"Example",id:"example",level:3},{value:"Note about reconciling an drifted Cloudformation grain (Beta)",id:"note-about-reconciling-an-drifted-cloudformation-grain-beta",level:3},{value:"Setting stack prefixes",id:"setting-stack-prefixes",level:3}],c={toc:u},p="wrapper";function d(e){let{components:t,...n}=e;return(0,a.kt)(p,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"The CloudFormation grain represents Torque's native support for AWS CloudFormation templates. Torque enables designers to utilize CloudFormation features for orchestrating both self-developed and community-driven CloudFormation modules in a consistent manner, making them accessible as reusable building blocks. For a complete YAML blueprint example, refer to ",(0,a.kt)("a",{parentName:"p",href:"/blueprint-designer-guide/blueprint-quickstart-guide#example-multi-grain-blueprint-2-web-game-on-s3-using-cloudformation-and-terraform"},"Example 2: Webgame on S3 (using CloudFormation and Terraform)"),"."),(0,a.kt)("h1",{id:"prerequisites"},"Prerequisites"),(0,a.kt)("p",null,"Before utilizing CloudFormation with Torque, ensure that you have the following prerequisites in place:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"An S3 bucket designated for the temporary storage of large templates.")),(0,a.kt)("p",null,'For templates exceeding 50K bytes in size, Torque requires a "template-storage" location to upload templates from a Git repository, enabling the creation of CloudFormation stacks. To fulfill this requirement, you must either create a new S3 bucket or provide an existing one, which will serve as the landing area. Templates are fetched from Git and stored in this bucket, from where they can be launched.'),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"An AWS policy for use of cloudformation.")),(0,a.kt)("p",null,"To grant Torque the necessary permissions to successfully provision resources, your credentials must include at least the following policy:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Sid": "BasicBucketOperations",  // Sid for the template-storage bucket. If all your temaplates are smaller than 50K, this can be omitted. \n            "Effect": "Allow",\n            "Action": [\n                "s3:PutObject",\n                "s3:GetObject",\n                "s3:DeleteObject"\n            ],\n            "Resource": [\n                "arn:aws:s3:::<your-bucket>/*" // the template-storage bucket name. \n            ]\n        },\n        {\n            "Sid": "BasicCfnOperations",\n            "Effect": "Allow",\n            "Action": [\n                "cloudformation:CreateStack",\n                "cloudformation:DeleteStack",\n                "cloudformation:UpdateStack",\n                "cloudformation:DescribeStacks",\n                "cloudformation:DescribeStackEvents"\n            ],\n            "Resource": "*"\n        },\n    {\n    // Any other permissions that are required to launch the resources inside the template. For example, if your template is using EC2 you can use:\n    //"Statement": [\n    //  {\n    //    "Action": "ec2:*",\n    //    "Effect": "Allow",\n    //    "Resource": "*"\n    //  }\n    // ]\n    }\n    ]\n}\n')),(0,a.kt)("h3",{id:"region"},"region"),(0,a.kt)("p",null,"Region is a required key in the cloudformation grain. It defines where the stack will be created."),(0,a.kt)("h3",{id:"source"},"source"),(0,a.kt)("p",null,"Please see ",(0,a.kt)("a",{parentName:"p",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#source"},"the grain source")," for more details."),(0,a.kt)("h3",{id:"agent"},"agent"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"agent")," is now ",(0,a.kt)("strong",{parentName:"p"},"required")," for CloudFormation Grain. Please see ",(0,a.kt)("a",{parentName:"p",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#Agent"},"the agent")," for more details."),(0,a.kt)("h3",{id:"authentication"},"authentication"),(0,a.kt)("p",null,"To enable Torque to connect to the AWS account and deploy the CloudFormation template, you have two options:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Authenticate with Torque credentials (AWS access key and secret key OR AWS role ARN to be assumed by Torque)"),(0,a.kt)("li",{parentName:"ol"},"Authenticate with a service account that will be attached to the runner which provisions the infrastructure. The service account needs to be annotated by an AWS role ARN to be assumed by Torque. ")),(0,a.kt)("p",null,"Option 1:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  database:\n    kind: cloudformation\n    spec:\n      source:\n        store: my-repo\n        path: folder/my-app\n      agent: \n        name: my-agent  \n      authentication:\n        - credential_name or {{.inputs.credentials_input_name}}\n")),(0,a.kt)("p",null,"Option 2:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  database:\n    kind: cloudformation\n    spec:\n      source:\n        store: my-repo\n        path: folder/my-app\n      ...\n      agent:\n        name: my-agent \n        service-account: agent-service-account # Optional. If not provided, Torque will try to use the default service account of the agent.\n\n")),(0,a.kt)("h3",{id:"template-storage-configuration"},"Template-Storage Configuration"),(0,a.kt)("p",null,"In the CloudFormation grain, you will need to specify the details of the S3 bucket serving as the template-storage for larger templates."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  database:\n    kind: cloudformation\n    spec:\n        ...\n      template-storage:\n         bucket-name: <name> # required, can be templated \n         region: <region> # required, can be templated\n         key-prefix: <prefix> # optional, can be templated . This is the file path where the template will be located inside the bucket.\n")),(0,a.kt)("p",null,"The template-storage is an optional element in the grain, however if you will not provide it only templates which are smaller than 50K bytes will be supported. It is also required when using nested stacks.\nIf you provide a bucket for template-storage, ensure that your service-account or credentials which you provided for Torque to provision your stack contain the permissions to read from the bucket as above."),(0,a.kt)("h3",{id:"inputs"},"inputs\u200b"),(0,a.kt)("p",null,"Similar to blueprint inputs, CloudFormation grain inputs allow you to reuse the same CloudFormation module in different ways. Inputs provided to the CloudFormation grain are used when launching the CloudFormation module."),(0,a.kt)("h3",{id:"tags"},"tags\u200b"),(0,a.kt)("p",null,"Whenever a CloudFormation grain is launched, all resources created during the deployment process are automatically tagged with Torque's system tags, built-in tags and custom tags."),(0,a.kt)("h3",{id:"outputs"},"outputs\u200b"),(0,a.kt)("p",null,"Outputs are strings generated by CloudFormation during the deployment process."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  database:\n    kind: cloudformation\n    spec:\n      source:\n        store: my-repo\n        path: folder/my-app\n        ...\n      authentication:\n        ...\n      outputs:\n        - agent_name\n        - connection_string\n")),(0,a.kt)("h3",{id:"example"},"Example"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  S3-Bucket:\n    kind: cloudformation\n    spec: \n      source:\n        path: https://.../AWSS3Bucket.yaml\n      inputs:\n        - AccessControl: '{{ .inputs.[\"Access Control\"] }}'\n        - BucketName: '{{ .inputs.[\"Bucket Name\"] }}-{{ sandboxid | downcase }}'\n      outputs:\n         - Arn\n         - DomainName\n")),(0,a.kt)("h3",{id:"note-about-reconciling-an-drifted-cloudformation-grain-beta"},"Note about reconciling an drifted Cloudformation grain (Beta)"),(0,a.kt)("p",null,"Resolving drift in AWS CloudFormation involves acknowledging the updated configuration as the intended state and adjusting the stack template accordingly. Conversely, in Torque, the process of drift resolution or reconciliation entails undoing changes made to cloud resources and restoring them to the original template. It is important to understand this distinction before reconciling CloudFormation grains."),(0,a.kt)("p",null,"Due to AWS limitations, if the drift includes deleted resources Torque will not be able to restore these via reconciliation. It is advise to reconcile the stack manually via the AWS console or CLI."),(0,a.kt)("h3",{id:"setting-stack-prefixes"},"Setting stack prefixes"),(0,a.kt)("p",null,"You can prefix all stacks created by Toque with some customized prefix, to adhere to your organization standards or conventions. There are several ways to do it."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Define a system parameter"),(0,a.kt)("li",{parentName:"ol"},"Define it in the blueprint")),(0,a.kt)("p",null,"Defining a system parameter means to create an account level or space level parameter with the predefined name SYSTEM_CFN_STACK_NAME_PREFIX and the string you wish to use as a prefix as value.\nUsing this system parameter means that the prefix will be applied to all Cloudformation stacks that are created by Torque in the entire account (if it's in the account level) or in the space (if it's a space level)."),(0,a.kt)("p",null,"To be more granular one can also define it in a specific blueprint like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  stack1:\n    kind: cloudformation\n    spec:\n      ...\n      stack-name-prefix: some-prefix\n      ...\n")),(0,a.kt)("p",null,"Where the value for the prefix can be fixed, come from input, or be a liquid template."))}d.isMDXComponent=!0}}]);