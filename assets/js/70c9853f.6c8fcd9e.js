"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([[405],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return d}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=l(n),d=r,h=m["".concat(c,".").concat(d)]||m[d]||p[d]||o;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},7972:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return c},default:function(){return d},frontMatter:function(){return s},metadata:function(){return l},toc:function(){return p}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],s={sidebar_position:4,title:"Service Accounts"},c=void 0,l={unversionedId:"blueprint-designer-guide/Service Accounts",id:"blueprint-designer-guide/Service Accounts",title:"Service Accounts",description:"A kubernetes service account provides an identity for processes that run in a pod. We recommend using service accounts if you are using a Kubernetes cluster as your execution host.",source:"@site/docs/blueprint-designer-guide/Service Accounts.md",sourceDirName:"blueprint-designer-guide",slug:"/blueprint-designer-guide/Service Accounts",permalink:"/blueprint-designer-guide/Service Accounts",editUrl:"https://github.com/QualiTorque/torque-docs/tree/master/docs/blueprint-designer-guide/Service Accounts.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4,title:"Service Accounts"},sidebar:"torqueSidebar",previous:{title:"Autogenerated Blueprints",permalink:"/blueprint-designer-guide/Autogenerated Blueprints"},next:{title:"Blueprint Policies",permalink:"/blueprint-designer-guide/Policies"}},u={},p=[{value:"Helm charts",id:"helm-charts",level:2},{value:"Terraform modules",id:"terraform-modules",level:2},{value:"AWS",id:"aws",level:3},{value:"Steps",id:"steps",level:4},{value:"Steps",id:"steps-1",level:4},{value:"Role definition examples",id:"role-definition-examples",level:3}],m={toc:p};function d(e){var t=e.components,s=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},m,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"A kubernetes service account provides an identity for processes that run in a pod. We recommend using service accounts if you are using a Kubernetes cluster as your execution host.\nThe service account is specified in the ",(0,o.kt)("strong",{parentName:"p"},"grains")," section of the blueprint, in the ",(0,o.kt)("strong",{parentName:"p"},"hosts")," node:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="Blueprint yaml:"',title:'"Blueprint','yaml:"':!0},"...\ngrains:\n  my-grain-name:\n    kind : terraform \n    spec:\n      ...\n      host:\n        name : <execution-host-name>\n        service-account : <service-account-name>\n      ...\n")),(0,o.kt)("h2",{id:"helm-charts"},"Helm charts"),(0,o.kt)("p",null,"When you're deploying resources in the cluster using a Helm chart, the service account you use should have sufficient permissions to create all the resources which the chart will deploy. For details, see ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions"},"Kubernetes' ServiceAccount permissions")),(0,o.kt)("h2",{id:"terraform-modules"},"Terraform modules"),(0,o.kt)("h3",{id:"aws"},"AWS"),(0,o.kt)("p",null,"If you're using an EKS cluster as your execution host, and you want to deploy resources to an AWS account, you can use service account to do the authentication and permissions between the pod and the AWS account where the resources will be created."),(0,o.kt)("h4",{id:"steps"},"Steps"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Create an IAM OIDC provider for your cluster (",(0,o.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html"},"Instructions"),")."),(0,o.kt)("li",{parentName:"ol"},"Create the IAM role to be used by the service account. (",(0,o.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/create-service-account-iam-policy-and-role.html"},"Instructions"),")."),(0,o.kt)("li",{parentName:"ol"},"Associate the IAM role to a service account on your cluster (",(0,o.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/specify-service-account-role.html"},"Instructions\u200b"),").",(0,o.kt)("br",{parentName:"li"}),"If the Terraform resources are to be created in a different AWS account than the one hosting the EKS cluster which is our execution host, you'll need to perform steps (1) and (2) on the target account. See ",(0,o.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html"},"AWS' Technical overview"),".")),(0,o.kt)("h4",{id:"steps-1"},"Steps"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create an IAM ",(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html"},"OIDC provider")," for your source EKS cluster account."),(0,o.kt)("p",{parentName:"li"},"The OIDC provider should be displayed in your cluster's ",(0,o.kt)("strong",{parentName:"p"},"Details")," page."),(0,o.kt)("blockquote",{parentName:"li"},(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("img",{alt:"Locale Dropdown",src:n(2453).Z,width:"1870",height:"884"})))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create an IAM ",(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html"},"OIDC provider")," for your target EKS account.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Add the source OIDC provider to the Identity provider."),(0,o.kt)("p",{parentName:"li"},"a. In the ",(0,o.kt)("strong",{parentName:"p"},"IAM")," dashboard, select ",(0,o.kt)("strong",{parentName:"p"},"Identity providers")," from the left menu and click ",(0,o.kt)("strong",{parentName:"p"},"Add provider"),"."),(0,o.kt)("blockquote",{parentName:"li"},(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("img",{alt:"Locale Dropdown",src:n(6722).Z,width:"1656",height:"687"}))),(0,o.kt)("p",{parentName:"li"},"b. Click ",(0,o.kt)("strong",{parentName:"p"},"OpenID Connect")," and specify your source cluster's OIDC provider URL."),(0,o.kt)("blockquote",{parentName:"li"},(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("img",{alt:"Locale Dropdown",src:n(8198).Z,width:"708",height:"257"})))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/create-service-account-iam-policy-and-role.html"},"IAM role")," and policy on the target account for your source service account."),(0,o.kt)("p",{parentName:"li"},"There are several ways to create a new IAM permission policy. One way is to copy a complete AWS managed policy that already does some of what you're looking for and then customize it to your specific requirements. Check out the ",(0,o.kt)("a",{parentName:"p",href:"#role-definition-examples"},"Role definition examples")," at the bottom of this procedure."),(0,o.kt)("p",{parentName:"li"},"a. In the ",(0,o.kt)("strong",{parentName:"p"},"Roles")," page, specify the source EKS cluster's IAM OIDC provider. For example:"),(0,o.kt)("blockquote",{parentName:"li"},(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("img",{alt:"Locale Dropdown",src:n(7037).Z,width:"1866",height:"875"}))),(0,o.kt)("p",{parentName:"li"},"b. In the ",(0,o.kt)("strong",{parentName:"p"},"Policies")," page, ")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Create an IAM role for your Kubernetes service accounts to use before you associate it with a service account. The trust relationship is scoped to your cluster and service account ",(0,o.kt)("strong",{parentName:"p"},"so that each cluster and service account combination requires its own role"),". You can then attach a specific IAM policy to the role that gives the containers in your pods the permissions you desire."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre"},"kubectl apply \u2013f app-sa.yaml\n")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="app-sa.yaml:"',title:'"app-sa.yaml:"'},"apiVersion: v1\nkind: ServiceAccount\nmetadata:\nannotations:\n  eks.amazonaws.com/role-arn: arn:aws:iam::XXX:role/YYY\nname: app-sa\nnamespace: quali\nautomountServiceAccountToken: true\n\n")),(0,o.kt)("ol",{start:5},(0,o.kt)("li",{parentName:"ol"},"Create a service account on your source EKS cluster with the Role ARN you created on the target account.")),(0,o.kt)("h3",{id:"role-definition-examples"},"Role definition examples"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="Example 1:"',title:'"Example','1:"':!0},'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Principal": {\n        "Federated": "arn:aws:iam::<source EKS cluster IAM OIDC provider>"\n      },\n      "Action": "sts:AssumeRoleWithWebIdentity",\n      "Condition": {\n        "StringEquals": {\n          "oidc.eks.eu-west-1.amazonaws.com/id/C5BASAB7D85CFECA473C4FG7E3BBD57B:sub": "system:serviceaccount:my-service-account:test-terraform-sa",\n          "oidc.eks.eu-west-1.amazonaws.com/id/C5BASAB7D85CFECA473C4FG7E3BBD57B:aud": "sts.amazonaws.com"\n        }\n      }\n    }\n  ]\n}\n')),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"The above example, make sure to specify the source EKS cluster's IAM OIDC provider and service account."))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="Example 2:"',title:'"Example','2:"':!0},'{\n\xa0\xa0\xa0 "Version": "2012-10-17",\n\xa0\xa0\xa0 "Statement": [\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0 {\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "Sid": "c828ad4376724afe992ed4670d339cde",\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "Effect": "Allow",\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "Principal": {\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "Federated": "arn:aws:iam::101105463363:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/28522D8BF95AE6F20147BFCADFB81F0F"\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 },\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "Action": "sts:AssumeRoleWithWebIdentity",\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "Condition": {\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "ForAnyValue:StringLike": {\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "oidc.eks.us-east-1.amazonaws.com/id/28522D8BF95AE6F20147BFCADFB81F0F:sub": [\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "system:serviceaccount:torque-review1-sb:*",\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "system:serviceaccount:torque-sb:torque-services-sa-*"\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 ],\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 "oidc.eks.us-east-1.amazonaws.com/id/28522D8BF95AE6F20147BFCADFB81F0F:aud": "sts.amazonaws.com"\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 }\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0 }\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0 }\n\xa0\xa0\xa0 ]\n}\n\n')),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"The above example, configures a role for any service account that starts with .."))))}d.isMDXComponent=!0},8198:function(e,t,n){t.Z=n.p+"assets/images/add-oidc-to-idp-2-152f201928edb4a81cef377dff1bb7bc.png"},6722:function(e,t,n){t.Z=n.p+"assets/images/add-oidc-to-idp-f35631ce86409c258047dd71920a241f.png"},7037:function(e,t,n){t.Z=n.p+"assets/images/iam-role-for-service-account-e3a0404d9b1f038516409e31407c7d98.png"},2453:function(e,t,n){t.Z=n.p+"assets/images/source-eks-oidc-provider-ebb29bb34d2cfb3c00c60ef9cf09f463.png"}}]);