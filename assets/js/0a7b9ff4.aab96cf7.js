"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([[1544],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=p(n),m=i,h=d["".concat(s,".").concat(m)]||d[m]||c[m]||r;return n?a.createElement(h,o(o({ref:t},u),{},{components:n})):a.createElement(h,o({ref:t},u))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1855:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(7462),i=(n(7294),n(3905));const r={sidebar_position:4,title:"Blueprint YAML Structure"},o=void 0,l={unversionedId:"blueprint-designer-guide/blueprints/blueprints-yaml-structure",id:"blueprint-designer-guide/blueprints/blueprints-yaml-structure",title:"Blueprint YAML Structure",description:"The Torque's blueprint YAML is the main blueprint definition file. It contains general information about the environment as well as the grains that make up the environment's applications and services. The blueprint YAML is published to end-users in Torque's blueprint catalog.",source:"@site/docs/blueprint-designer-guide/blueprints/blueprints-yaml-structure.md",sourceDirName:"blueprint-designer-guide/blueprints",slug:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure",permalink:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure",editUrl:"https://github.com/QualiTorque/torque-docs/tree/master/docs/blueprint-designer-guide/blueprints/blueprints-yaml-structure.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4,title:"Blueprint YAML Structure"},sidebar:"torqueSidebar",previous:{title:"Blueprint YAML Overview",permalink:"/blueprint-designer-guide/blueprints/blueprints-overview"},next:{title:"The Ansible Grain",permalink:"/blueprint-designer-guide/blueprints/ansible-grain"}},s={},p=[{value:"The Blueprint spec",id:"the-blueprint-spec",level:2},{value:"<code>spec_version</code>",id:"spec_version",level:3},{value:"<code>description</code>",id:"description",level:3},{value:"<code>instructions</code>",id:"instructions",level:3},{value:"<code>inputs</code>",id:"inputs",level:3},{value:"File Input Type",id:"file-input-type",level:4},{value:"<code>outputs</code>",id:"outputs",level:3},{value:"<code>grains</code>",id:"grains",level:3},{value:"<code>source</code>",id:"source",level:3},{value:"<code>agent</code>",id:"agent",level:3},{value:"<code>depends-on</code>",id:"depends-on",level:3},{value:"<code>labels</code>",id:"labels",level:3},{value:"<code>layout</code>",id:"layout",level:3},{value:"Grains inputs &amp; outputs",id:"grains-inputs--outputs",level:2},{value:"Torque Templating Engine",id:"torque-templating-engine",level:2},{value:"Dynamic Attributes",id:"dynamic-attributes",level:3},{value:"Parameters",id:"parameters",level:3},{value:"Environment Variables",id:"environment-variables",level:2},{value:"Disabling Auto-Retry",id:"disabling-auto-retry",level:2},{value:"Workspace directories",id:"workspace-directories",level:2},{value:"Configuring Workspace Directories",id:"configuring-workspace-directories",level:3},{value:"Accessing Workspace Directories",id:"accessing-workspace-directories",level:3},{value:"Working with Artifactory as Binary Repository",id:"working-with-artifactory-as-binary-repository",level:3}],u={toc:p},d="wrapper";function c(e){let{components:t,...r}=e;return(0,i.kt)(d,(0,a.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"The Torque's blueprint YAML is the main blueprint definition file. It contains general information about the environment as well as the grains that make up the environment's applications and services. The blueprint YAML is published to end-users in Torque's blueprint catalog."),(0,i.kt)("h2",{id:"the-blueprint-spec"},"The Blueprint spec"),(0,i.kt)("h3",{id:"spec_version"},(0,i.kt)("inlineCode",{parentName:"h3"},"spec_version")),(0,i.kt)("p",null,"The spec_version determines the blueprint YAML type. Currently, Torque supports spec_version:2 as the default and recommended version. With time, new preview releases and official feature releases will bring more and more features and users will be able to use other spec versions."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"spec_version: 2\n")),(0,i.kt)("h3",{id:"description"},(0,i.kt)("inlineCode",{parentName:"h3"},"description")),(0,i.kt)("p",null,"The blueprint\u2019s description is an optional but recommended field. Blueprint description will be presented in the Torque's UI and API so users consuming environment will have more information about the blueprints to batter match their business need to the available set of blueprints published in the account catalog."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"spec_version: 2\ndescription: Performance testing deployment based on RDS, EKS and Lambda\n\n")),(0,i.kt)("h3",{id:"instructions"},(0,i.kt)("inlineCode",{parentName:"h3"},"instructions")),(0,i.kt)("p",null,"Instructions are the recommended way for the blueprint developer to communicate with the end user and explain how to use this blueprint. The instructions can be simple text, or a complete MarkDown file, hosted in your git repository. "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'spec_version: 2\ndescription: Performance testing deployment based on RDS, EKS and Lambda\ninstructions:\n  text: "This is what you need to know ... " # text option\n  source:\n    store: <The name of the repository which contains the instructions as it was onboarded to Torque>\n    path : <instructions/something.md> # path inside the repository where the instructions md file is located. Must be in a folder called "instructions".\n\n')),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},"Blueprint instructions can be located in the same repository as the blueprints or a different repository"),(0,i.kt)("li",{parentName:"ul"},"Torque will use only markdown files located in the \u201c/instructions\u201d folder under the root of the onboarded repository"),(0,i.kt)("li",{parentName:"ul"},"Torque will support external resources embed in the markdown under the following rules:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Any link to external and publicly exposed resource"),(0,i.kt)("li",{parentName:"ul"},"Relative path to images, svg and gif files located within the /instructions folder"),(0,i.kt)("li",{parentName:"ul"},"Images, svg and gif files smaller than 1MB."))),(0,i.kt)("li",{parentName:"ul"},"Torque will not support relative .md references -Torque will not allow to load/redirect to another markdown mentioned in the markdown provided as the blueprint instructions.")))),(0,i.kt)("h3",{id:"inputs"},(0,i.kt)("inlineCode",{parentName:"h3"},"inputs")),(0,i.kt)("p",null,"Blueprint designers can publish blueprint inputs to their end-users to add flexibility while launching a new environment from the blueprints, without altering the blueprint code itself. Input data can be later used in the blueprint to control orchestration, pass information to automation processes, and more."),(0,i.kt)("p",null,"The input definition is composed out of the following fields: "),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The input name"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"description")," is presented to all users in the Torque UI and API's (Optional)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"type")," of the input. Options are:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"string")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"agent")," allows the environment end-user to select the agent that will deploy the grain(s) from a dropdown list. By default, all agents are listed in the dropdown list, but you can add ",(0,i.kt)("inlineCode",{parentName:"li"},"allowed-values")," to only display a subset of the agents. For details, see ",(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#agent"},"agent"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"parameter")," will take the input's allowed values from the parameter-store, from a parameter with the name ",(0,i.kt)("inlineCode",{parentName:"li"},"parameter-name"),". The parameter can be defined either in the account level or in the space level. If the parameter's value is built as a comma separated list, Torque will convert them to a set of values and present it to the end-user as a drop down list of the values. See an example below. For more info about the parameter store, click ",(0,i.kt)("a",{parentName:"li",href:"/admin-guide/params"},"here"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"credentials")," allows the environment end-user to select the credentials that will be used to deploy the grain(s) from a dropdown list. By default, all credentials in the account are listed in the dropdown list, but you can add ",(0,i.kt)("inlineCode",{parentName:"li"},"allowed-values")," to only display a subset of the credentials. "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"file")," allows the environment end-user to upload one or more files from the launch form. The uploaded files are made available to the blueprint designer using the ",(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#workspace-directories"},(0,i.kt)("inlineCode",{parentName:"a"},"workspace-directories"))," section and the ",(0,i.kt)("strong",{parentName:"li"},"env-storage")," store - ",(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#file-input-type"},"See details below"),"."))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"style")," (Optional): Defines how the input is presented to the user. For example:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"radio")," displays the allowed values as radio buttons. This is useful for binary or mutually exclusive choices. The input ",(0,i.kt)("inlineCode",{parentName:"li"},"type")," must be ",(0,i.kt)("inlineCode",{parentName:"li"},"string")," when using this style."))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"sensitive"),": ",(0,i.kt)("inlineCode",{parentName:"li"},"true")," masks the value behind asterisks in the UI and API. (Default is ",(0,i.kt)("inlineCode",{parentName:"li"},"false"),") "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"default")," - (Optional) Value to be used in the Torque UI and will be used in case no other value provided for the input. If a default value is not defined, the environment end-user will need to provide one when launching the environment."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"allowed-values")," converts the input into a dropdown list, allowing the environment end-user to select the appropriate value. If a ",(0,i.kt)("inlineCode",{parentName:"li"},"default")," is specified, it must be included in the allowed values list. "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"quick"),' is an optional boolean value. Setting it to "true" or omitting it will cause the input to be presented to the end user in the "quick links" section of the environment. Setting it to "false" means it will not appear in that section.'),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"pattern")," is an optional regular expression pattern that the input value must match. If provided, Torque will validate the user input against this pattern during environment launch and prevent launching if the input does not conform to the specified pattern."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"validation-description")," is an optional user-friendly message or description that will be shown to the user if the provided input value does not match the specified ",(0,i.kt)("inlineCode",{parentName:"li"},"pattern"),". This helps provide better guidance to the user on the expected input format or constraints.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'inputs:\n  app_version:\n    type: string\n    allowed-values: [0.9.7, 0.9.8, 0.9.9]\n    default: "0.9.9"\n    description: "The version of the application to be deployed on the EKS cluster"\n  agent:\n    type: agent\n    allowed-values: [NY, Tokyo, London]\n    description: "Select your site\'s agent."\n  email_address:\n    type: string\n    description: "Enter a valid email address"\n    pattern: \'^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$\'\n    validation-description: "The provided value is not a valid email address. Please enter an email in the format \'name@example.com\'."\n  debug-mode:\n    type: string\n    style: radio\n    allowed-values: [true, false]\n    description: "Enable or disable debug mode for the application"\n')),(0,i.kt)("p",null,"The inputs section in the Torque blueprint YAML also supports spaces to make inputs more user friendly. Configuring an input with a friendly name can be done in the following way:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'inputs:\n  Application Version:\n    type: string\n    default: "0.4.3"\n    description: "The version of the microservices application"\n')),(0,i.kt)("p",null,"To use an input that was configured using spaces, make sure to encase the input in the following way:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"inputs:\n  Application Version:\n    type: string\n\ngrains:\n  nested-bp:\n    kind: blueprint\n    spec: \n      inputs: \n        - version: '{{ .inputs.[\"Application Version\"] }}'\n")),(0,i.kt)("p",null,"To apply a set of allowed input values from the parameter store, use the following syntax:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"inputs:\n  region:\n    type: parameter\n    parameter-name: aws-allowed-regions \n")),(0,i.kt)("p",null,'We then configure a parameter with name: aws-allowed-regions and value "us-east-1,us-east2" .\nThe end user will be presented with a drop down of these 2 values as the allowed values options.'),(0,i.kt)("h4",{id:"file-input-type"},"File Input Type"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"file")," input type allows users to upload files from the launch form. These files are made available to the blueprint designer using the ",(0,i.kt)("a",{parentName:"p",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#workspace-directories"},(0,i.kt)("inlineCode",{parentName:"a"},"workspace-directories"))," section and the ",(0,i.kt)("inlineCode",{parentName:"p"},"env-storage")," store. This is useful for scenarios where the environment requires user-provided files (such as configuration, data, or scripts) at launch time."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"File input fields:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"type: file")," (required)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"max-size-MB"),": Maximum allowed file size in megabytes (required)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"max-files"),": Maximum number of files that can be uploaded (required)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"allowed-formats"),": List of allowed file extensions (required)")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Example:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"spec_version: 2\ndescription: \"Blueprint with file input type\"\n\ninputs:\n  agent:\n    type: 'agent'\n  txt-files:\n    type: 'file'\n    max-size-MB: 1\n    max-files: 2\n    allowed-formats:\n      - 'txt'\n\ngrains:\n  print-txt-file:\n    kind: 'shell'\n    spec:\n      agent:\n        name: '{{.inputs.agent}}'\n      workspace-directories:\n        - source:\n            name: 'SOURCE_DIR'\n            store: 'env-storage/{{.inputs.txt-files}}'\n      activities:\n        deploy:\n          commands:\n            - 'echo $SOURCE_DIR/*'\n            - 'echo print file content'\n            - 'first_file=$(ls $SOURCE_DIR/*.txt | head -n 1) ; cat $first_file'\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"How it works:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The user uploads up to 2 ",(0,i.kt)("inlineCode",{parentName:"li"},".txt")," files (each up to 1MB) when launching the environment."),(0,i.kt)("li",{parentName:"ul"},"The files are made available in the environment as a workspace directory using the ",(0,i.kt)("inlineCode",{parentName:"li"},"env-storage")," store and the input name."),(0,i.kt)("li",{parentName:"ul"},"The grain can access the uploaded files using the specified directory name (e.g., ",(0,i.kt)("inlineCode",{parentName:"li"},"$SOURCE_DIR"),").")),(0,i.kt)("h3",{id:"outputs"},(0,i.kt)("inlineCode",{parentName:"h3"},"outputs")),(0,i.kt)("p",null,"Outputs exposes information about your newly deployed environment and make it available for the environment's end-user or automation processes. Outputs will usually be available at the end of the environment's initialization and accessible throughout the environment lifecycle."),(0,i.kt)("p",null,"Outputs are a dictionary composed by the output name and the output value."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"outputs:\n  website-url:\n    value: 'https://application-name-{{ sandboxid | downcase }}.quali.click'\n    quick: true # optional. default false\n    kind: link\n  db-hostname:\n    value: '{{ .grains.mysql.outputs.hostname }}'\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"quick: true")," attribute is optional and defaults to false. Setting it to ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," will cause the specific output to be presented in the ",(0,i.kt)("strong",{parentName:"p"},"Quick Access")," section of the environment for ease of use."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The example above includes some of the Torque's YAML templating engine capabilities allowing the blueprint designer more flexibility and leads to less code that will require maintenance. More examples for templating will be described ",(0,i.kt)("a",{parentName:"p",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#torque-templating-engine"},"Torque Templating engine"),"."))),(0,i.kt)("p",null,"The outputs section in the Torque blueprint YAML also supports spaces to make outputs more user friendly in the following way:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"outputs:\n  Database Connection String:\n    value: '{{ .grains.mysql.outputs.connection_string }}'\n")),(0,i.kt)("p",null,"When using outputs with spaces in a nested blueprint, make sure encase the output name in the following way:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'outputs:\n  Database Connection String:\n    value: \'{{ .grains.mysql.outputs.["Database Connection String"] }}\'\n\ngrains:\n  nested-bp:\n    kind: blueprint\n    spec: \n      outputs: \n        - "Database Connection String"\n')),(0,i.kt)("h3",{id:"grains"},(0,i.kt)("inlineCode",{parentName:"h3"},"grains")),(0,i.kt)("p",null,"Grains are the basic building blocks of a blueprint utilizing infrastructure as code (IaC) assets or automation processes to orchestrate the desired environment. In many organization, the blueprint designers will have a predefined set of grains they can use in blueprints provided by the IT/Ops/DevOps or platform team. "),(0,i.kt)("p",null,"The basic grain template is composed out of the grain name, kind, inputs and output. specific grains might support other features that are technology specific."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grain_name:\n    kind: terraform\n    spec:\n      source: \n        store: <connected repo name>\n        path: <path to module>\n      agent:\n        name: '{{ .inputs.agent_name }}'\n      inputs:\n        - input1: '{{ .inputs.value1 }}'\n        - input1: '{{ .inputs.value2 }}'\n      outputs:\n        - output1\n        - output2\n")),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Note that in auto-generated blueprints, the ",(0,i.kt)("strong",{parentName:"p"},"grain_name.spec.agent.name")," is automatically published as a blueprint input, which the blueprint designer can use. As a best practice, it's recommended to remove the ",(0,i.kt)("strong",{parentName:"p"},"agent.name")," input once the blueprint is published to the catalog."))),(0,i.kt)("p",null,"The following grains are available:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/terraform-grain"},"Terraform")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/opentofu-grain"},"OpenTofu")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/helm-grain"},"Helm")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/kubernetes-grain"},"Kubernetes")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/shell-grain"},"Shell")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/ansible-grain"},"Ansible")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/cloudformation-grain"},"CloudFormation")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/blueprint-grain"},"Blueprint")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/cloudshell-grain"},"CloudShell"))),(0,i.kt)("h3",{id:"source"},(0,i.kt)("inlineCode",{parentName:"h3"},"source")),(0,i.kt)("p",null,"Sources are repositories storing IaC, CM or other configuration technology that will be utilized by Torque to launch and operate an environment. Torque supports multiple ways to define grain sources.\nSources can be defined in the following ways:"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"1. Direct link to a source control folder"),":"),(0,i.kt)("p",null,"Composed from the repository URL followed by the folder structure leading to the folder where IaC code resides. For example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  aurora:\n    kind: terraform\n    spec:\n      source:\n        store: my-repo # connected repository name\n        path: folder/my-app # path to module\n\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"2. Location based on a repository (blueprints or assets) onboarded to Torque"),": "),(0,i.kt)("p",null,"The name of the repository should be provided under the 'store' field, while the IaC code folder location should be specified under the path field. In the below example, nginx helm chart resides in the 'nginx' folder within a repository onboarded to Torque with the name 'web_servers'."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  nginx:\n    kind: helm\n    spec:\n      source:\n        store: web_servers\n        path: nginx\n")),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"In case your IaC code is not under folder in the repository, the path should be set as in the following example:"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"      source:\n        store: web_servers\n        path: .\n")))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"3. Working with branches, commits and tags"),":"),(0,i.kt)("p",null,"You can reference an asset in a specific branch, commit or tag."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml:"},"grains:\n  dev-env:\n    kind: terraform\n    spec:\n      source:\n        store: infra\n        path: vms\n        branch: feature/one\n        commit: b39e0a9e86aab97d255af22507f700936a3f2ef5\n        tag: test-133 \n")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},"You can specify only one of the parameters (",(0,i.kt)("inlineCode",{parentName:"li"},"branch")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"commit")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"tag"),")."),(0,i.kt)("li",{parentName:"ul"},'If "tag" is provided, Torque will track the repo for newer tags. In other words, if a newer tag is found, then an "update" will be detected.'),(0,i.kt)("li",{parentName:"ul"},'If "branch" is provided, Torque will track the head of the branch. In other words, when new commits arrive, an "update" will be detected.'),(0,i.kt)("li",{parentName:"ul"},'If "commit" is provided, Torque ',(0,i.kt)("strong",{parentName:"li"},"will not")," track changes.")))),(0,i.kt)("h3",{id:"agent"},(0,i.kt)("inlineCode",{parentName:"h3"},"agent")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"agent")," defines the agent that will deploy the grain. While different grains behave differently, it's important to choose the right agent for a grain to make sure authentication, networking and configuration is all properly configured. Different grains in the same blueprint can use different agents to allow maximum flexibility during the orchestration processes."),(0,i.kt)("p",null,"You can specify the agent in two ways:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Literally. For example:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  # launch an RDS instance using Terraform\n  rds:\n    kind: terraform\n    spec:\n      agent:\n        name: my-agent\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},'Using an input of type "agent", which allows the environment end-user to select the agent to use from a dropdown list. For details, see the ',(0,i.kt)("a",{parentName:"li",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#inputs"},"blueprint yaml's inputs")," section.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  rds:\n    kind: terraform\n    spec:\n      agent:\n        name: '{{ inputs.agent_name }}'\n")),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Agents gives the flexibility of deploying the same blueprints over different cloud accounts and cloud vendors. For example, the same blueprint can be utilized for Azure or GCP simply by exposing the agent as a blueprint input, from which the end-user to choose their preferred cloud provider, each represented with a different agent."))),(0,i.kt)("p",null,"The agent's configuration must include:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"name")," - the given name for the kubernetes cluster configured under the cloud account area where the grain will be executed.")),(0,i.kt)("p",null,"Optionally, the agent configuration may include:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"storage-size")," - Set the size of storage allocated to this grain. The size is in MB. The size must be smaller than the overall storage size which was defined in the ",(0,i.kt)("a",{parentName:"li",href:"/torque-agent/advanced-settings"},"agent settings"),". If not defined, Torque will use the default size. This is an advanced configuration option, it is recommended to consult with Torque's support team before making a change."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"runner-namespace")," - The namespace where the runner pod will be provisioned. If not defined, the runners will be provisioned in the default namespace defined in the agent level. This is an advanced configuration option, it is recommended to consult with Torque's support team before making a change."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"service-account")," - The service-account name configured within the kubernetes cluster that will be used to execute the grain. A kubernetes\nservice account provides an identity for processes that run in a pod. If not specified, Torque will use the default service account defined for the agent. The service account must be defined in the runner namespace."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"isolated")," - A boolean value (",(0,i.kt)("inlineCode",{parentName:"li"},"true")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"false"),") indicating whether the grain should run in isolation on a runner. If not defined, the default is determined internally based on the configuration (e.g., if agent's storage class supports ",(0,i.kt)("inlineCode",{parentName:"li"},"ReadWriteMany"),", the default is ",(0,i.kt)("inlineCode",{parentName:"li"},"false"),").")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  # launch an RDS instance using Terraform\n  rds:\n    kind: terraform\n    spec:\n      agent:\n        name: eks-ohio # Required\n        storage-size: 800 # Optional\n        runner-namespace: my-namespace # Optional\n        service-account: torque-sa # Optional\n        isolated: true # Optional\n")),(0,i.kt)("p",null,"You can add the ",(0,i.kt)("inlineCode",{parentName:"p"},"node-selector")," and/or ",(0,i.kt)("inlineCode",{parentName:"p"},"pod-labels")," sections to your grain and specify the node labels you want the target node(s) to have.\xa0The ",(0,i.kt)("inlineCode",{parentName:"p"},"node-selector")," and its labels will be applied on the pod specification.\xa0Kubernetes only schedules the pod onto nodes that have each of the labels you specify. "),(0,i.kt)("p",null,"For example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  nginx:\n    kind: helm\n    spec: \n      source:\n        ...\n      agent:\n        name:\n        kubernetes:\n          node-selector:\n            - app: torque\n          pod-labels:\n            - app: torque\n")),(0,i.kt)("h3",{id:"depends-on"},(0,i.kt)("inlineCode",{parentName:"h3"},"depends-on")),(0,i.kt)("p",null,"The need to deploy one IaC component before the other is common and usually required when 3rd party components, managed services and other teams need to provide the infrastructure. Using dependencies in the blueprint YAML Torque will evaluate and optimize the deployment process to make sure dependencies are respected and components with no dependencies will be deployed in parallel to maximize efficiency and reduce overall uptime."),(0,i.kt)("p",null,"In the example below, 3 grain in the blueprint will be deployed in the following order: rds and redis will be deployed in parallel - and my_app will be deployed next, only in case of a successful deployment."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  rds:\n    # launch an AWS RDS instance using Terraform\n    kind: terraform\n\ngrains:\n  redis:\n    # launch an AWS ElastiCache using CloudFormation\n    kind: cloudformation\n\n  my_app_demo:\n    # launcing K8s based microservices application using Helm\n    depends-on: rds, redis\n    kind: helm\n")),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The ability to use outputs from specific grain usually requires the grain deployment to finish successfully. designing a blueprint with output usually requires dependencies between the grains."))),(0,i.kt)("h3",{id:"labels"},(0,i.kt)("inlineCode",{parentName:"h3"},"labels")),(0,i.kt)("p",null,"The labels block in your blueprint YAML structure allows you to attach metadata to environments created from the blueprint. Each label is a key-value pair. "),(0,i.kt)("p",null,"Labels can be static, like ",(0,i.kt)("inlineCode",{parentName:"p"},"key: value"),", or dynamic, using input variables like ",(0,i.kt)("inlineCode",{parentName:"p"},"version: '{{ .inputs.version }}'"),". In the dynamic case, the value of the label is determined by the value provided for the version input when the blueprint is used to create an environment. This enables customization of environments based on user-defined inputs."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("ol",{parentName:"div"},(0,i.kt)("li",{parentName:"ol"},"The labels are applied to the environment, not the blueprint itself, and won't appear as part of the catalog item's metadata. "),(0,i.kt)("li",{parentName:"ol"},"The environment labels will be merged with any blueprint labels already defined.")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"spec_version: 2\ndescription: ...\n\nlabels:\n  - key: value\n  - version: '{{ .inputs.version }}'\n\ninputs:\n  version:\n    type: string\n\ngrains: ...\n")),(0,i.kt)("h3",{id:"layout"},(0,i.kt)("inlineCode",{parentName:"h3"},"layout")),(0,i.kt)("p",null,"Layout is a separate yaml that will be referenced from the blueprint yaml like so:"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},'The layout yaml must reside inside a folder named "layouts".'))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"spec_version: 2\ndescription: ...\nlayout:\n  source:\n    store: <connected repo>\n    path: <path to layout file>\n  exclude-from-layout:  # optional\n    - grain_name_1\n    - grain_name_2\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("strong",{parentName:"p"},"layout")," element is where the blueprint references the layout that will be applied to environments created from it. To learn more, visit ",(0,i.kt)("a",{parentName:"p",href:"/blueprint-designer-guide/layouts/"},"layouts")),(0,i.kt)("p",null,"The ",(0,i.kt)("strong",{parentName:"p"},"exclude-from-layout")," element is optional, use it in case you need to apply the layout only to part of the grains but not all of them."),(0,i.kt)("h2",{id:"grains-inputs--outputs"},"Grains inputs & outputs"),(0,i.kt)("p",null,"Inputs and outputs are used both in the blueprint level and in the grains level. Grains can use inputs and outputs to pass data between IaC components, validate information and eventually lead to reducing the amount of IaC components that needs to be maintained by the organization."),(0,i.kt)("p",null,"In the below example, a Terraform deployment generates a connection string to a managed database that can then be utilized by the application itself using the ability to pass output from one grain as a input to the other."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  rds:\n    # launch an RDS instance using Terraform\n    kind: terraform\n    spec:\n      ...\n      outputs:\n        - connection_string\n\n  my_app_demo:\n    # launcing k8s based microservices application using HELM\n    kind: helm\n    depends-on: rds\n    spec:\n      ...\n      inputs:\n        - db.connectionString: '{{ .grains.rds.outputs.connection_string }}'\n")),(0,i.kt)("h2",{id:"torque-templating-engine"},"Torque Templating Engine"),(0,i.kt)("p",null,"Templating engines are a great way to enrich the YAML format to allow extensibility points and text manipulations. Torque utilizes a GO-Lang style engine called ",(0,i.kt)("a",{parentName:"p",href:"https://shopify.github.io/liquid/"},"Shopify Liquid")," to allow dynamic injection of parameters and inputs as well as provider attribute values via reference of other attributes within the same YAML.\nExample:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Insert Blueprint input from the user as a value for a Grain input. "),(0,i.kt)("li",{parentName:"ul"},"Insert Parameter Store information as a value for a Grain attribute or input. "),(0,i.kt)("li",{parentName:"ul"},'Reference an output from a grain as an input or attribute of another grain (mandates "depends-on:" relationship between the grains)')),(0,i.kt)("p",null,"In the below example the ",(0,i.kt)("a",{parentName:"p",href:"https://shopify.github.io/liquid/filters/downcase/"},"downcase")," and ",(0,i.kt)("a",{parentName:"p",href:"https://shopify.github.io/liquid/filters/strip/"},"strip")," keywords are used with concatenation of the sandbox id to create a new S3 bucket (AWS) using Terraform while making sure the bucket name will be valid and unique."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"  s3_bucket:\n    kind: terraform\n    spec:\n      source:\n        store: assets\n        path: s3\n      agent:\n        name: '{{ .inputs.agent_name }}'\n      inputs:\n        - bucket_name: '{{ .inputs.bucket_name | strip }}-bucket-{{ envid | downcase }}'\n")),(0,i.kt)("p",null,"For details and examples of how to use the parameters from the parameter store inside blueprints, check ",(0,i.kt)("a",{parentName:"p",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#parameters"},"this article"),"."),(0,i.kt)("h3",{id:"dynamic-attributes"},"Dynamic Attributes"),(0,i.kt)("p",null,"Blueprint designers might need extra details about the account, space or environment during the environment's orchestration. Torque provides dynamic attributes which are pre-defined parameters blueprints designers can use. The currently supported dynamic attributes are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"envId")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"blueprintName")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"ownerEmail")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"environmentName")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"accountName")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"spaceName"))),(0,i.kt)("p",null,"Here is an example of how it can be used:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"  s3_bucket:\n      ...\n      inputs:\n        - bucket_name: 'bucket-{{ envId | downcase }}'\n")),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},'The dynamic attributes calculation is case insensitive so you can use either "envId" or "envid" etc.'))),(0,i.kt)("h3",{id:"parameters"},"Parameters"),(0,i.kt)("p",null,"Torque's ",(0,i.kt)("a",{parentName:"p",href:"/admin-guide/params"},"Parameters")," store allows admins to set pre-defined account/space-level parameters. Blueprint designers can use the parameters in the blueprint YAML, instead of inputs if they don't want the environment end-user to provide the value, but also don't want to hard-code it in the blueprint."),(0,i.kt)("p",null,"The syntax is: ",(0,i.kt)("inlineCode",{parentName:"p"},"{{ .params.param-value }}")),(0,i.kt)("p",null,"The syntax is the same for both account and space level parameters. A space-level parameter will take precedence over an account-level parameter with the same name."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  s3_bucket:\n    kind: terraform\n    spec:\n      source:\n        store: assets\n        path: s3\n      agent:\n        name: '{{ .inputs.agent_name }}'\n      inputs:\n        - bucket_name: '{{ .params.my-bucket }}'\n")),(0,i.kt)("h2",{id:"environment-variables"},"Environment Variables"),(0,i.kt)("p",null,"In many cases, passing information through environment variables is required for IaC modules to properly execute with the right data in mind. The environment variables provided under a specific grain will be accessible only during the grain lifecycle of the specific grain and can be used as a specific string or to be derived from a blueprint input or other grain output. "),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The env-vars field is relevant only to concrete IaC grains (e.g., terraform, helm, ansible, shell, etc.) and does not apply to grains of kind 'blueprint'."))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"  s3_bucket:\n    kind: \n    spec:\n      ...\n      env-vars:\n        - VAR_NAME1: value1\n        - VAR_NAME2: '{{ .inputs.input_name }}'\n        - VAR_NAME3: '{{ .grains.vm.outputs.agent_name }}'\n")),(0,i.kt)("h2",{id:"disabling-auto-retry"},"Disabling Auto-Retry"),(0,i.kt)("p",null,"In some situations, Torque will automatically retry to deploy failed grains. This behavior is usually very beneficial but it might not be suitable in all cases.\nIn case you wish to exclude a specific grain from the auto-retry, include the following in the blueprint:"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The auto-retry currently applies only to terraform grain. To learn more about auto retry, see ",(0,i.kt)("a",{parentName:"p",href:"/environment-services/drift-and-update#auto-retry-failed-deployments"},"auto-retry")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  s3:\n    kind: terraform\n    spec:\n      source:\n      ...\n      auto-retry: false  # optional\n")),(0,i.kt)("p",null,'The auto-retry element is optional . If not present, it defaults to "true". Can be "true" or "false".'),(0,i.kt)("h2",{id:"workspace-directories"},"Workspace directories"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The ",(0,i.kt)("inlineCode",{parentName:"p"},"workspace-directories")," is supported for all grain types."))),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"workspace-directories")," section allows you to specify a list of source repositories that will be checked out and made available in the workspace during the deployment process. These repositories can contain files that are required, such as configuration files, scripts, or any other supporting files."),(0,i.kt)("h3",{id:"configuring-workspace-directories"},"Configuring Workspace Directories"),(0,i.kt)("p",null,"Within the ",(0,i.kt)("inlineCode",{parentName:"p"},"workspace-directories")," section, you can specify one or more sources. Each source is defined as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  app:\n    kind: helm\n    spec:\n      agent:  \n      ...\n      workspace-directories:\n        - source:\n            store: <connected repo name>\n            name: DIRECTORY_NAME # used to access the checked-out files in the workspace\n            tag: <tag> # can be replaced with branch: <branch name> or commit: <commit sha>\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"store"),": The name of the store (repository) where the source files are located."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"name"),": The name that will be used to access the checked-out files in the workspace. This name will be available as an environment variable during the execution of commands."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"tag"),": The tag of the repository to be checked out. (can be replaced with ",(0,i.kt)("inlineCode",{parentName:"li"},"branch: <branch name>")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"commit: <commit sha>"),")")),(0,i.kt)("h3",{id:"accessing-workspace-directories"},"Accessing Workspace Directories"),(0,i.kt)("p",null,"Taking Helm for example, during the execution of commands specified in the ",(0,i.kt)("inlineCode",{parentName:"p"},"commands")," section, you can access the checked-out files from the workspace-directories using the environment variables that correspond to the ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," specified for each source."),(0,i.kt)("p",null,"For example, if you have defined two workspace directories with the names ",(0,i.kt)("inlineCode",{parentName:"p"},"APP_CONFIG_REPO")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"APP_VALUES_REPO"),", you can access their contents using the ",(0,i.kt)("inlineCode",{parentName:"p"},"${APP_CONFIG_REPO}")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"${APP_VALUES_REPO}")," environment variables, respectively."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n  app:\n    kind: helm\n    spec:\n      agent:\n      ...\n      commands:\n        - list && cp -R ${APP_CONFIG_REPO}/src/main/config ${WORK_DIR}\n        - list && cp -R ${APP_VALUES_REPO}/global/config ${WORK_DIR}\n")),(0,i.kt)("p",null,"In the above example, the ",(0,i.kt)("inlineCode",{parentName:"p"},"cp")," command copies files from the ",(0,i.kt)("inlineCode",{parentName:"p"},"src/main/config")," directory of the ",(0,i.kt)("inlineCode",{parentName:"p"},"APP_CONFIG_REPO")," repository and the ",(0,i.kt)("inlineCode",{parentName:"p"},"global/config")," directory of the ",(0,i.kt)("inlineCode",{parentName:"p"},"APP_VALUES_REPO")," repository into the ",(0,i.kt)("inlineCode",{parentName:"p"},"${WORK_DIR}")," directory."),(0,i.kt)("p",null,"In this case, the entire repository will be checked out, and the ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," specified (",(0,i.kt)("inlineCode",{parentName:"p"},"ROOT_DIR"),") can be used to access the root directory in the workspace."),(0,i.kt)("h3",{id:"working-with-artifactory-as-binary-repository"},"Working with Artifactory as Binary Repository"),(0,i.kt)("p",null,"Artifactory is a popular binary repository manager that can store and manage various types of artifacts, including Docker images, Helm charts, and other binary files. In Torque, you can use Artifactory as a source for binary files that are required during the deployment process. This can be particularly useful for scenarios such as:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Storing and managing Helm charts or other application configuration files"),(0,i.kt)("li",{parentName:"ul"},"Storing and managing Terraform state files or other infrastructure-related artifacts"),(0,i.kt)("li",{parentName:"ul"},"Storing and managing Docker images or other container-related artifacts")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Motivation and Scope")),(0,i.kt)("p",null,"Using Artifactory as a binary repository in Torque provides several benefits:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Centralized Artifact Management"),": Artifactory acts as a centralized repository for all your binary artifacts, making it easier to manage and distribute them across multiple environments.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Version Control"),": Artifactory supports versioning and tagging of artifacts, allowing you to track changes and roll back to previous versions if needed.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Access Control"),": Artifactory provides granular access control mechanisms, allowing you to control who can access and modify specific artifacts.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Caching and Proxying"),": Artifactory can cache and proxy remote repositories, reducing network traffic and improving performance.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Integration with CI/CD Pipelines"),": Artifactory integrates seamlessly with various CI/CD tools, making it easier to manage artifacts throughout the software delivery pipeline."))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Usage Example")),(0,i.kt)("p",null,"To use Artifactory as a binary repository in Torque, you need to configure it as a workspace directory within your blueprint. Here's an example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="Artifactory - Blueprint usage example"',title:'"Artifactory',"-":!0,Blueprint:!0,usage:!0,'example"':!0},"vm-grain:\n    kind: terraform\n    spec:\n      source:\n        store: tf-modules\n        path: aws/deploy_vm\n      agent:\n        name: '{{.inputs.agent}}'\n      inputs:\n        - name: '{{.inputs.vm_name}}'\n      workspace-directories:\n// highlight-start\n        - source:\n            name: file1            \n            store: artifactory/my-artifactory-store # working with Artifactory\n            path: helm/charts.tar.gz\n        - source:\n            name: file2\n            store: artifactory/my-artifactory\n            path: artifactory/tf/workspaces/jfrog-ws1/state.latest.json \n// highlight-end\n        - source: \n            name: dir1\n            store: my-repo # working with repositories\n            commit: eb7bf547f916ff11f0f95e35fb1e8c6fd6535ce1\n")),(0,i.kt)("p",null,"In this example, we have two workspace directories (",(0,i.kt)("inlineCode",{parentName:"p"},"file1")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"file2"),") that are configured to use Artifactory as the source. The ",(0,i.kt)("inlineCode",{parentName:"p"},"store")," parameter specifies the Artifactory store name, which should be prefixed with ",(0,i.kt)("inlineCode",{parentName:"p"},"artifactory/"),". The ",(0,i.kt)("inlineCode",{parentName:"p"},"path")," parameter specifies the path within the Artifactory store where the desired artifact is located."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Setup")),(0,i.kt)("p",null,"To use Artifactory with Torque, you need to configure an Artifactory credential in the Credentials Store. "),(0,i.kt)("p",null,"In Torque portal, navigate to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Account Settings")," and to the Credentials page. Click on the ",(0,i.kt)("inlineCode",{parentName:"p"},"Add Credentials")," button and choose ",(0,i.kt)("inlineCode",{parentName:"p"},"JFrog Artifactory"),"."),(0,i.kt)("p",null,"Provide a ",(0,i.kt)("inlineCode",{parentName:"p"},"Name")," and a ",(0,i.kt)("inlineCode",{parentName:"p"},"Description"),", select the allowed ",(0,i.kt)("inlineCode",{parentName:"p"},"Spaces")," that can use that Artifactory server, fill in the ",(0,i.kt)("inlineCode",{parentName:"p"},"Server URL")," and the ",(0,i.kt)("inlineCode",{parentName:"p"},"Token")," and hit the ",(0,i.kt)("inlineCode",{parentName:"p"},"Apply")," button."),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"artifactory",src:n(283).Z,width:"1776",height:"630"})),(0,i.kt)("p",null,"You are also able to create an Artifactory credential using the Torque REST API as well. Here is an example on setting up Artifactory credentials on a space level:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-curl",metastring:'title="API call to setup Artifactory credentials on a space level"',title:'"API',call:!0,to:!0,setup:!0,Artifactory:!0,credentials:!0,on:!0,a:!0,space:!0,'level"':!0},'POST {{host}}/api/spaces/{{space}}/settings/credentialstore\n{\n  "name": "my-artifactory",             # need to change\n  "allowed_space_names": ["{{space}}"], # need to change\n  "cloud_identifier": "artifactory", \n  "cloud_type": "artifactory",\n  "credential_data": {\n    "server_url": "https://artifactory.jfrog.io/artifactory", # need to change\n    "token": "1234",                    # need to change\n    "type": "artifactory"\n  }\n}\n')),(0,i.kt)("p",null,"In this example, we're creating an Artifactory credential named ",(0,i.kt)("inlineCode",{parentName:"p"},"my-artifactory")," with the server URL and a token for authentication. Currently, Torque supports Artifactory token authentication."),(0,i.kt)("p",null,"Once the Artifactory credential is configured, you can reference it in your blueprint's ",(0,i.kt)("inlineCode",{parentName:"p"},"workspace-directories")," section using the ",(0,i.kt)("inlineCode",{parentName:"p"},"store")," parameter, as shown in the usage example above."))}c.isMDXComponent=!0},283:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/artifactory-1587a1ae3f0ce5a4f72fd07b0d8ddefb.png"}}]);