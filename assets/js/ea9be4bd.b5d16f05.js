"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([["7090"],{5190:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>a,toc:()=>l,default:()=>u,metadata:()=>r,assets:()=>c,contentTitle:()=>o});var r=JSON.parse('{"id":"torque-agent/service-accounts-for-azure","title":"Terraform AKS/Azure Authentication","description":"If you\'re using an AKS cluster as your agent, and you want to run Terraform that deploys resources on Azure, you can use a Azure Workload Identity (valid for AKS clusters version 1.22+) that allows the cluster to securely authenticate with Azure using K8s service account and an Open ID connect (OIDC) token.","source":"@site/docs/torque-agent/service-accounts-for-azure.md","sourceDirName":"torque-agent","slug":"/torque-agent/service-accounts-for-azure","permalink":"/torque-agent/service-accounts-for-azure","draft":false,"unlisted":false,"editUrl":"https://github.com/QualiTorque/torque-docs/tree/master/docs/torque-agent/service-accounts-for-azure.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"Terraform AKS/Azure Authentication"},"sidebar":"torqueSidebar","previous":{"title":"Terraform EKS/AWS Authentication","permalink":"/torque-agent/service-accounts-for-aws"},"next":{"title":"Terraform GKE/GCP Authentication","permalink":"/torque-agent/service-accounts-for-gcp"}}'),i=t(4848),s=t(4429);let a={sidebar_position:4,title:"Terraform AKS/Azure Authentication"},o=void 0,c={},l=[{value:"<strong>Azure Configuration</strong>",id:"azure-configuration",level:2},{value:"<strong>Prerequisites</strong>",id:"prerequisites",level:3},{value:"<strong>Configure the Azure Workload Identity</strong>",id:"configure-the-azure-workload-identity",level:3},{value:"<strong>Torque Configuration</strong>",id:"torque-configuration",level:2},{value:"<strong>Prerequisites</strong>",id:"prerequisites-1",level:3},{value:"<strong>Configure the AKS authentication in Torque</strong>",id:"configure-the-aks-authentication-in-torque",level:3},{value:"<strong>Video: Connecting a new agent and using it in a blueprint</strong>",id:"video-connecting-a-new-agent-and-using-it-in-a-blueprint",level:3}];function d(e){let n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["If you're using an AKS cluster as your agent, and you want to run Terraform that deploys resources on Azure, you can use a Azure Workload Identity (valid for AKS clusters version 1.22+) that allows the cluster to securely authenticate with Azure using K8s service account and an Open ID connect (OIDC) token.\nFor a step-by-step tutorial, see ",(0,i.jsx)(n.a,{href:"#video-connecting-a-new-agent-and-using-it-in-a-blueprint",children:"Video: Connecting a new agent and using it in a blueprint"}),"."]}),"\n",(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsx)(n.mdxAdmonitionTitle,{children:(0,i.jsx)(n.strong,{children:"IMPORTANT"})}),(0,i.jsxs)(n.p,{children:["Torque does not support running the Torque Agent on an AKS cluster using ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/virtual-machines/sizes-b-series-burstable",children:"Burst Type VMs"})," as cluster worker nodes.  Please use a different VM type."]})]}),"\n",(0,i.jsx)(n.p,{children:"The basic process is as follows:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"#azure-configuration",children:(0,i.jsx)(n.strong,{children:"Azure Configuration"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#prerequisites",children:(0,i.jsx)(n.strong,{children:"Prerequisites"})})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#configure-the-azure-workload-identity",children:(0,i.jsx)(n.strong,{children:"Configure the Azure Workload Identity"})})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"#torque-configuration",children:(0,i.jsx)(n.strong,{children:"Torque Configuration"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#prerequisites-1",children:(0,i.jsx)(n.strong,{children:"Prerequisites"})})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#configure-the-aks-authentication-in-torque",children:(0,i.jsx)(n.strong,{children:"Configure the AKS authentication in Torque"})})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#video-connecting-a-new-agent-and-using-it-in-a-blueprint",children:"Video: Connecting a new agent and using it in a blueprint"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"azure-configuration",children:(0,i.jsx)(n.strong,{children:"Azure Configuration"})}),"\n",(0,i.jsx)(n.h3,{id:"prerequisites",children:(0,i.jsx)(n.strong,{children:"Prerequisites"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Azure CLI installed locally or use Azure CLI in Azure portal","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If not installed: Download the MSI from ",(0,i.jsx)(n.a,{href:"https://aka.ms/installazurecliwindows",children:"https://aka.ms/installazurecliwindows"})," and run the installer."]}),"\n",(0,i.jsxs)(n.li,{children:["Update to latest:","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"az upgrade\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Install aks-preview Azure CLI extension and update extension to latest:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"az extension add --name aks-preview\naz extension update --name aks-preview\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:["Command-line with ",(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tools/#kubectl",children:"kubectl installed"})," connected the cluster where you installed the Torque agent.\nTo connect to the cluster use:"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"kubectl config use-context <your-cluster>\n"})}),"\n",(0,i.jsx)(n.h3,{id:"configure-the-azure-workload-identity",children:(0,i.jsx)(n.strong,{children:"Configure the Azure Workload Identity"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Set CLI context to the Azure Subscription the AKS cluster is in:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"az account set --subscription (subscription name or ID)\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Enable WorkloadIdentity feature on Azure Subscription:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:'az feature register --namespace "Microsoft.ContainerService" --name "EnableWorkloadIdentityPreview"\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:'This step may take 10-20 minutes until it is in effect, use the below command to check the state of the registration until it says "Registered"'})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Check registration status:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:'az feature show --namespace "Microsoft.ContainerService" --name "EnableWorkloadIdentityPreview"\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:"Propagate registration:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"az provider register --namespace Microsoft.ContainerService\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"5",children:["\n",(0,i.jsx)(n.li,{children:"Update the AKS cluster to enable OIDC and Workload Identity:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"az aks update -g {aks_resource_group_name} -n {aks_cluster_name} --enable-oidc-issuer --enable-workload-identity  \n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:'Copy the "issuerURl" from the response to this command to a note for use later as OIDC_ISSUER_URL.'})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Create a managed identity and grant permissions:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"az identity create --name {Managed_Identity_Name} --resource-group {AKS_Resource_Group_Name} --location {resource_group_location} --subscription {aks_cluster_subscription_id}\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:'Copy the Managed Identity\'s name and "client id" to a note for use later.'})}),"\n",(0,i.jsxs)(n.ol,{start:"7",children:["\n",(0,i.jsx)(n.li,{children:'Add permissions to the managed identity at the subscription level using azure portal (this example uses the "contributor" role. You can select a different role, that has enough permissions to run your terraform modules):'}),"\n"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["a. Go to the ",(0,i.jsx)(n.strong,{children:"Subscriptions"})," page (type in the search box \u201Csubscriptions\u201D)."]}),"\n",(0,i.jsx)(n.p,{children:"b. Click the appropriate subscription."}),"\n",(0,i.jsxs)(n.p,{children:["c. Select ",(0,i.jsx)(n.strong,{children:"Access Control (IAM)"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["d. Click ",(0,i.jsx)(n.strong,{children:"+ Add"})," and select ",(0,i.jsx)(n.strong,{children:"Add role assignment"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["e. Select ",(0,i.jsx)(n.strong,{children:"Contributor"})," and click ",(0,i.jsx)(n.strong,{children:"Next"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["f. In the ",(0,i.jsx)(n.strong,{children:"Members"})," page, select the ",(0,i.jsx)(n.strong,{children:"User, group or service principle"})," option and click the ",(0,i.jsx)(n.strong,{children:"+ Select members"})," link."]}),"\n",(0,i.jsxs)(n.p,{children:["g. Use the search bar to find and select the managed identity. Then, click ",(0,i.jsx)(n.strong,{children:"Select"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["h. Click ",(0,i.jsx)(n.strong,{children:"Create"})," to create the role assignment."]}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"8",children:["\n",(0,i.jsx)(n.li,{children:"Create a file called aks_workload_id_service_account.yaml with the below content:"}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"Replace the {property name} with the corresponding values. For service account name, choose a new name. Take a note of the namespace that you select for Torque Environments (it will be in use in the next part - Torque configuration)"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:'apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  annotations:\n    azure.workload.identity/client-id: {Managed_Identity_Client_ID}\n  labels:\n    azure.workload.identity/use: "true"\n  name: {New_Service_Account_Name}\n  namespace: {Torque_Environments_K8s_Namespace} \n'})}),"\n",(0,i.jsxs)(n.ol,{start:"9",children:["\n",(0,i.jsx)(n.li,{children:"Apply the file on your AKS Cluster"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"kubectl apply -f {path_to_file}\\aks_workload_id_service_account.yaml  \n"})}),"\n",(0,i.jsxs)(n.ol,{start:"10",children:["\n",(0,i.jsx)(n.li,{children:"Establish federated identity credential (Allow the AKS Cluster's OIDC provider access to the Managed Identity via the service account)"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"az identity federated-credential create --name {federated_credential_name} --identity-name {managed_identity_name} --resource-group {managed_identity_resource_group} --issuer {AKS_cluster_OIDC_issuer_URL} --subject system:serviceaccount:{Torque_Environments_K8s_namespace}:{service_account_name}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"torque-configuration",children:(0,i.jsx)(n.strong,{children:"Torque Configuration"})}),"\n",(0,i.jsx)(n.h3,{id:"prerequisites-1",children:(0,i.jsx)(n.strong,{children:"Prerequisites"})}),"\n",(0,i.jsx)(n.p,{children:"Have the following formation ready (from the previous section)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Tenant ID (displayed in the ",(0,i.jsx)(n.strong,{children:"Azure Active Directory > Overview"}),")"]}),"\n",(0,i.jsx)(n.li,{children:"Subscription ID"}),"\n",(0,i.jsx)(n.li,{children:"The namespace where the Torque environments will run (which you chose previously) and the service account name (which you also created in the previous step)."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"configure-the-aks-authentication-in-torque",children:(0,i.jsx)(n.strong,{children:"Configure the AKS authentication in Torque"})}),"\n",(0,i.jsx)(n.p,{children:"There are 2 ways to accomplish this:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["(Recommended) When adding a new AKS agent, you can provide the ",(0,i.jsx)(n.strong,{children:"default tenant Id"}),", and when attaching it a space you can provide the ",(0,i.jsx)(n.strong,{children:"default_subscription"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["a. From the ",(0,i.jsx)(n.strong,{children:"Administration"})," menu, select ",(0,i.jsx)(n.strong,{children:"Cloud Accounts"})," and then ",(0,i.jsx)(n.strong,{children:"Connect a Cloud"}),"."]}),"\n",(0,i.jsx)(n.p,{children:'b. Choose "Azure" then "AKS" and fill the information:'}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Locale Dropdown",src:t(8809).A+"",width:"740",height:"550"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["c. ",(0,i.jsx)(n.strong,{children:"Generate"}),' the "kubectl apply" command and run it in Azure CLI.']}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Locale Dropdown",src:t(5488).A+"",width:"740",height:"550"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:'d. Return to Torque and wait for the connection status to change to a green "Connected!".'}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Locale Dropdown",src:t(4608).A+"",width:"742",height:"552"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["d. Click ",(0,i.jsx)(n.strong,{children:"Associate to Space"})," and connect the agent to one or more spaces. Select the namespace and the service account you configured in the previous step."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Locale Dropdown",src:t(2639).A+"",width:"740",height:"550"})}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"You may override the default credentials defined for the AKS agent, or define the credentials if no credentials were configured as the default.\na. In the Terraform grain, specify the service-account name under spec > agent:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"spec:\n  source:\n    ...\n  namespace:\n  agent:\n    name: {aks_torque_agent_name}\n    service account: {new_service_account_name} # this is the k8s service account created above    \n"})}),"\n",(0,i.jsxs)(n.p,{children:["b. Under ",(0,i.jsx)(n.code,{children:"env-vars"}),", add the following (will override the default definition of the AKS agent):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"ARM_SUBSCRIPTION_ID: <Subscription_ID>\nARM_TENANT_ID: <Tenant_ID>\nARM_CLIENT_ID: <Client_ID>\n"})}),"\n",(0,i.jsx)(n.h3,{id:"video-connecting-a-new-agent-and-using-it-in-a-blueprint",children:(0,i.jsx)(n.strong,{children:"Video: Connecting a new agent and using it in a blueprint"})}),"\n",(0,i.jsx)("video",{controls:!0,width:"75%",children:(0,i.jsx)("source",{src:"/img/connect azure agent.mp4"})})]})}function u(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},5488:function(e,n,t){t.d(n,{A:()=>r});let r=t.p+"assets/images/AKS-doc-2-a-36fa906b8f692bef04ba31f0dae5d122.png"},8809:function(e,n,t){t.d(n,{A:()=>r});let r=t.p+"assets/images/AKS-doc-2-c1e4f28b48e52ce67a474eab28de3b42.png"},4608:function(e,n,t){t.d(n,{A:()=>r});let r=t.p+"assets/images/AKS-doc-3-f550a3709918d36279bf88915881d40b.png"},2639:function(e,n,t){t.d(n,{A:()=>r});let r=t.p+"assets/images/AKS-doc-4-0ae9bcea21f2a902905f12c4753fd724.png"},4429:function(e,n,t){t.d(n,{R:()=>a,x:()=>o});var r=t(6540);let i={},s=r.createContext(i);function a(e){let n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);