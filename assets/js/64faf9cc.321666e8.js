"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([[791],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>h});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var i=a.createContext({}),u=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},p=function(e){var n=u(e.components);return a.createElement(i.Provider,{value:n},e.children)},m="mdxType",c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=u(t),d=r,h=m["".concat(i,".").concat(d)]||m[d]||c[d]||o;return t?a.createElement(h,l(l({ref:n},p),{},{components:t})):a.createElement(h,l({ref:n},p))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,l=new Array(o);l[0]=d;var s={};for(var i in n)hasOwnProperty.call(n,i)&&(s[i]=n[i]);s.originalType=e,s[m]="string"==typeof e?e:r,l[1]=s;for(var u=2;u<o;u++)l[u]=t[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},210:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var a=t(7462),r=(t(7294),t(3905));const o={sidebar_position:24,title:"The Ansible Grain"},l=void 0,s={unversionedId:"blueprint-designer-guide/blueprints/ansible-grain",id:"blueprint-designer-guide/blueprints/ansible-grain",title:"The Ansible Grain",description:"The Ansible grain is Torque\u2019s native support for orchestrating the execution of Ansible playbooks as part of a Torque blueprint. The referenced playbook can rely on vars or inventory-hosts that are dynamically provided by Torque, and then utilize them to perform configuration management, updates, a health check or any other flow that is executable from Ansible.",source:"@site/docs/blueprint-designer-guide/blueprints/ansible-grain.md",sourceDirName:"blueprint-designer-guide/blueprints",slug:"/blueprint-designer-guide/blueprints/ansible-grain",permalink:"/blueprint-designer-guide/blueprints/ansible-grain",editUrl:"https://github.com/QualiTorque/torque-docs/tree/master/docs/blueprint-designer-guide/blueprints/ansible-grain.md",tags:[],version:"current",sidebarPosition:24,frontMatter:{sidebar_position:24,title:"The Ansible Grain"},sidebar:"torqueSidebar",previous:{title:"The Shell Grain",permalink:"/blueprint-designer-guide/blueprints/shell-grain"},next:{title:"The CloudShell Grain",permalink:"/blueprint-designer-guide/blueprints/cloudshell-grain"}},i={},u=[{value:"Tools and technologies",id:"tools-and-technologies",level:3},{value:"source",id:"source",level:3},{value:"agent",id:"agent",level:3},{value:"inputs",id:"inputs",level:3},{value:"Inventory-file",id:"inventory-file",level:3},{value:"Outputs",id:"outputs",level:3}],p={toc:u},m="wrapper";function c(e){let{components:n,...t}=e;return(0,r.kt)(m,(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"The Ansible grain is Torque\u2019s native support for orchestrating the execution of Ansible playbooks as part of a Torque blueprint. The referenced playbook can rely on vars or inventory-hosts that are dynamically provided by Torque, and then utilize them to perform configuration management, updates, a health check or any other flow that is executable from Ansible. "),(0,r.kt)("h3",{id:"tools-and-technologies"},"Tools and technologies"),(0,r.kt)("p",null,"The following tools and technologies are installed out of the box on our agents in the Kubernetes pods and can be used when designing ansible playbook execution:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"dotnet"),(0,r.kt)("li",{parentName:"ul"},"git"),(0,r.kt)("li",{parentName:"ul"},"python3"),(0,r.kt)("li",{parentName:"ul"},"pip3"),(0,r.kt)("li",{parentName:"ul"},"ansible"),(0,r.kt)("li",{parentName:"ul"},"openssh-client")),(0,r.kt)("h3",{id:"source"},"source"),(0,r.kt)("p",null,"The source section of an Ansible grain provides Torque with the information on where the Ansible playbook is stored and should be retrieved from. This could be either a direct source URL to an Ansible playbook YAML file, or it can be a reference from a Torque-connected git repository. "),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Example - direct:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"My_Ansible_Grain:\n  depends-on: Ubuntu_VM\n  kind: ansible\n  spec:\n    source:\n      path: https://github.com/MyOrg/my-repo//ansible/install_httpd_rhel.yaml\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Example - repository:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"My_Ansible_Grain:\n  kind: ansible\n  spec:\n    source:\n      store: assets\n      path: assets/ansible/install_apache2_webgame_ubuntu.yaml\n")),(0,r.kt)("h3",{id:"agent"},"agent"),(0,r.kt)("p",null,"Please see ",(0,r.kt)("a",{parentName:"p",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#host"},"the grain agent")," for more details."),(0,r.kt)("h3",{id:"inputs"},"inputs"),(0,r.kt)("p",null,'Inputs which are provided to the ansible grain will be used in the ansible command line as "extra-vars".\nThe syntax is similar to any grain inputs.'),(0,r.kt)("p",null,"Let's look at an example. In the example we have a blueprint with 2 grains: a VM and an ansible playbook to configure it."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Blueprint:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"spec_version: 2\n   ...   \ngrains:\n  my_vm:\n    kind: terraform\n    spec:\n      source:\n        store: assets\n        path:terraform/vcenter/linux_vm\n      outputs:\n      - vm_ip\n      - vm_link\n      - vm_name\n\n  configure-vm:\n    depends-on: my_vm\n    kind: ansible\n    spec:\n      source:\n        store: assets\n        path: assets/ansible/configure.yaml\n      inputs:\n        - nodes: '{{ grains.my_vm.outputs.vm_ip }}'\n        - username: '{{ .params.vc_ubuntu_user }}'\n        - password: '{{ .params.vc_ubuntu_password }}'\n")),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Torque supports playbooks which use ansible roles."))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Playbook:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'- hosts: {{ nodes }}\n  tasks:\n  - name: configure virtual machine\n    azure_rm_virtualmachine:\n      username: "{{ username }}"\n      password: "{{ password }}"\n      \u2026          \n')),(0,r.kt)("p",null,"Torque will create a JSON file containing the grain inputs under the path: /var/run/ansible/inputs/inputs.json."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "nodes": [...],\n  "username": ...,\n  "password": ...\n}\n')),(0,r.kt)("p",null,"The playbook will be executed with the extra vars in the following way:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'ansible-playbook myplaybook.yaml --extra-vars "@/var/run/ansible/inputs/inputs.json"\n')),(0,r.kt)("h3",{id:"inventory-file"},"Inventory-file"),(0,r.kt)("p",null,"Inventory file is a special grain section unique to the ansible grain, that allows you to provide in a YAML structured format, the content of the Ansible inventory file that will be generated for the Ansible playbook to use. For a deep understanding of the format of this file, please see the Ansible official documentation at ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#inventory-basics-formats-hosts-and-groups"},"https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#inventory-basics-formats-hosts-and-groups"),".\nThe general standard structure for such a file is as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"host_group:\n  hosts:\n    host1:\n      host1_var: host1_var_value\n    host2:\n      host2_var: host1_var_value\n  vars:\n    group_var: group_var_value\n")),(0,r.kt)("p",null,"Depending on the Ansible packages used in the playbook, these host and group variables may be used automatically by the package step (in which case, they must be provided in a specific name, for example an \u201cansible_become: yes/no\u201d group var will determine if the actions in the playbook need to be run as a different user from the host connection info.).\nVariables not defined on a host will automatically default to the values set in the vars section of the host_group. For example, the below playbook:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'---\n- gather_facts: no\n  hosts: all\n  tasks:\n  - name: Print Hello World\n    debug: \n      msg: "Hello World, my name is {{ person_name}}"\n')),(0,r.kt)("p",null,"with the below inventory file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"      inventory-file:\n        all:\n          hosts:\n            host1:\n              person_name: John\n            host2:          \n          vars:\n            person_name: Doe\n")),(0,r.kt)("p",null,"will result in this output"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'TASK [Print Hello World] *******************************************************\nok: [host1] => {\n    "msg": "Hello World, my name is John"\n}\nok: [host2] => {\n    "msg": "Hello World, my name is Doe"\n}\n')),(0,r.kt)("p",null,"Any section of the \u201cinventory-file:\u201d can contain dynamic values from dependent grains, from the blueprint\u2019s inputs or from Torque\u2019s parameter storage. For more information, see  ",(0,r.kt)("a",{parentName:"p",href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#torque-templating-engine"},"Torque Templating engine"),".\n",(0,r.kt)("strong",{parentName:"p"},"Example:")," Below is an example of a grains section of a blueprint, containing an Ansible grain:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"}," grains:\n  hello_world_ansible:\n    kind: ansible\n    spec:\n      source:\n        store: assets\n        path: ansible/hello_world.yaml\n      agent:\n        name: my-torque-agent\n      inventory-file:\n        all:\n          hosts:\n            host1:\n              person_name: John\n            host2:          \n          vars:\n            person_name: Doe\n")),(0,r.kt)("h3",{id:"outputs"},"Outputs"),(0,r.kt)("p",null,"Ansible does not support outputs from playbooks natively so Torque adds this support on top of the ansible capabilities.\nWhy would you need outputs from your ansible grain?\nOutput from the ansible grain can be passed to another grain (ansible or not) or to become one of the blueprint outputs so can be provided to the blueprint consumer (the end user)."),(0,r.kt)("p",null,'For this purpose, we have developed the Torque ansible module "export-torque-outputs".'),(0,r.kt)("p",null,"The module accepts a dictionary of output names and values. "),(0,r.kt)("p",null,"Usage example:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Playbook:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"tasks:\n  - name: task1\n      configure_vm:\n      \u2026\n      register: result1\n    \u2026\n  - name: task2\n      do_something_else:\n      \u2026\n      register: result2\n    \n\n - name: Export outputs\n    torque.collections.export_torque_outputs:\n      outputs:\n        output1: \u201c{{ result1 }}\u201d\n        output2: \u201c{{ result2 }}\u201d\n")),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},'The task which runs the "export_torque_outputs" module must be run on localhost. '))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Blueprint:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"grains:\n   configure-vm:\n      kind: ansible\n      spec:\n       ...\n       outputs:\n          - output1\n          - output2  \n")),(0,r.kt)("p",null,"If you wish to install the module locally to test it, please run ",(0,r.kt)("inlineCode",{parentName:"p"},"ansible-galaxy collection install torque.collections"),"\nThe module resides in the marketplace : ",(0,r.kt)("a",{parentName:"p",href:"https://galaxy.ansible.com/torque/collections"},"https://galaxy.ansible.com/torque/collections")))}c.isMDXComponent=!0}}]);