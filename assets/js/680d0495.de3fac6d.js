"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([["7664"],{9717:function(e,t,s){s.r(t),s.d(t,{frontMatter:()=>o,toc:()=>l,default:()=>d,metadata:()=>n,assets:()=>a,contentTitle:()=>c});var n=JSON.parse('{"id":"torque-agent/service-accounts-for-aws","title":"Terraform EKS/AWS Authentication","description":"If you\'re using an EKS cluster as your agent, and you want to run Terraform that deploys resources on AWS, you can use a service account to do the authentication and permissions between the pod and the AWS account where the resources will be created. This is done by connecting a service account, which contains these permissions, to the container. The permissions are defined in an IAM role that needs to be associated to the service account.","source":"@site/docs/torque-agent/service-accounts-for-aws.md","sourceDirName":"torque-agent","slug":"/torque-agent/service-accounts-for-aws","permalink":"/torque-agent/service-accounts-for-aws","draft":false,"unlisted":false,"editUrl":"https://github.com/QualiTorque/torque-docs/tree/master/docs/torque-agent/service-accounts-for-aws.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Terraform EKS/AWS Authentication"},"sidebar":"torqueSidebar","previous":{"title":"Install an Agent on your Kubernetes Cluster","permalink":"/torque-agent/Install-and-connect-self-hosted-agent"},"next":{"title":"Terraform AKS/Azure Authentication","permalink":"/torque-agent/service-accounts-for-azure"}}'),r=s(4848),i=s(4429);let o={sidebar_position:3,title:"Terraform EKS/AWS Authentication"},c=void 0,a={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Associate your cluster to the cluster account",id:"associate-your-cluster-to-the-cluster-account",level:2},{value:"Create an IAM role for the service account with the required policy",id:"create-an-iam-role-for-the-service-account-with-the-required-policy",level:2},{value:"Create a service account in the cluster\u2019s namespace",id:"create-a-service-account-in-the-clusters-namespace",level:2},{value:"For additional details, see these AWS docs:",id:"for-additional-details-see-these-aws-docs",level:2}];function h(e){let t={a:"a",admonition:"admonition",br:"br",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.p,{children:"If you're using an EKS cluster as your agent, and you want to run Terraform that deploys resources on AWS, you can use a service account to do the authentication and permissions between the pod and the AWS account where the resources will be created. This is done by connecting a service account, which contains these permissions, to the container. The permissions are defined in an IAM role that needs to be associated to the service account."}),"\n",(0,r.jsx)(t.p,{children:"The basic process is as follows:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"#prerequisites",children:"Prerequisites"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"#associate-your-cluster-to-the-cluster-account",children:"Associate your cluster to the cluster account"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"#create-an-iam-role-for-the-service-account-with-the-required-policy",children:"Create an IAM role for the service account with the required policy"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"#create-a-service-account-in-the-clusters-namespace",children:"Create a service account in the cluster\u2019s namespace"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"#for-additional-details-see-these-aws-docs",children:"For additional details, see these AWS docs:"})}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:['For brevity, the term "',(0,r.jsx)(t.strong,{children:"cluster account"}),'" refers to the account hosting the EKS, and "',(0,r.jsx)(t.strong,{children:"target accounts"}),'" is where the rest of the AWS resources are created.']}),"\n",(0,r.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html",children:"IAM OIDC provider"})," on the cluster\u2019s account, to recognize the cluster on the account"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html",children:"kubectl"})," connected to the cluster"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"https://aws.amazon.com/cli/",children:"AWS CLI"})," on your computer"]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"associate-your-cluster-to-the-cluster-account",children:"Associate your cluster to the cluster account"}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"To associate the cluster to the account"}),":"]}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"In AWS CLI, find the cluster\u2019s OIDC provider by running:"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-jsx",metastring:"title=",children:'aws eks describe-cluster --name my-cluster --query "cluster.identity.oidc.issuer" --output text\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Where ",(0,r.jsx)(t.strong,{children:"my-cluster"})," is the name of the cluster."]}),"\n",(0,r.jsx)(t.p,{children:"The output looks something like this:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-jsx",metastring:"title=",children:"https://oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Where ",(0,r.jsx)(t.strong,{children:"EXAMPLED539D4633E53DE1B71EXAMPLE"})," is the cluster's OIDC provider"]}),"\n",(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsx)(t.p,{children:"Make sure to perform steps 2 and 3 on every target account in which the cluster will perform actions."})}),"\n",(0,r.jsxs)(t.ol,{start:"2",children:["\n",(0,r.jsx)(t.li,{children:"Check if the OIDC provider from the cluster's account exists in the target accounts:"}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-jsx",metastring:"title=",children:"aws iam list-open-id-connect-providers | grep my-cluster-oidc-provider\n"})}),"\n",(0,r.jsx)(t.p,{children:"The IAM OIDC provider is displayed:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'"Arn": "arn:aws:iam::111122223333:oidc-provider/oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE"\n'})}),"\n",(0,r.jsxs)(t.ol,{start:"3",children:["\n",(0,r.jsx)(t.li,{children:"If the IAM OIDC provider is nonexistent, do the following to create it:"}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["a.	Install ",(0,r.jsx)(t.strong,{children:"eksctl"})," on your computer."]}),"\n",(0,r.jsx)(t.p,{children:"b.	Run the following to create the IAM OIDC provider and associate it to your cluster:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-jsx",metastring:"title=",children:"eksctl utils associate-iam-oidc-provider --cluster my-cluster --approve\n"})}),"\n",(0,r.jsx)(t.p,{children:"c.	In AWS CLI, run the following to get the Arn for IAM OIDC provider you created:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-jsx",metastring:"title=",children:"aws iam list-open-id-connect-providers | grep my-cluster-oidc-provider\n"})}),"\n",(0,r.jsx)(t.p,{children:"You will need this for step 3 in the following procedure."}),"\n",(0,r.jsx)(t.h2,{id:"create-an-iam-role-for-the-service-account-with-the-required-policy",children:"Create an IAM role for the service account with the required policy"}),"\n",(0,r.jsx)(t.p,{children:"As we explained before, the service account delegates permissions to the container to perform the Terraform actions. The permissions are defined as a policy in an IAM role that is associated to the service account.\nPerform these steps on every target account that will be used by your cluster."}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"Prerequisites"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"IAM policy with the desired permissions"}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"To create the IAM role for the service account"}),":"]}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["In your AWS Console, go to ",(0,r.jsx)(t.strong,{children:"IAM > Role"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Create role"}),", select ",(0,r.jsx)(t.strong,{children:"Web identity"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["From the ",(0,r.jsx)(t.strong,{children:"Identity"})," provider dropdown list, select the IAM OIDC that was generated in step 3-c of the above procedure."]}),"\n",(0,r.jsxs)(t.li,{children:["From the ",(0,r.jsx)(t.strong,{children:"Audience"})," dropdown list, select ",(0,r.jsx)(t.strong,{children:"sts.amazonaws.com"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Click ",(0,r.jsx)(t.strong,{children:"Next"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Select the ",(0,r.jsx)(t.strong,{children:"IAM policy"})," you wish to associate to the IAM role, and click ",(0,r.jsx)(t.strong,{children:"Next"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Specify a ",(0,r.jsx)(t.strong,{children:"Role name"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Scroll down and click ",(0,r.jsx)(t.strong,{children:"Create role"}),"."]}),"\n",(0,r.jsx)(t.li,{children:"Copy the ARN for this role. You will need in the next step."}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"create-a-service-account-in-the-clusters-namespace",children:"Create a service account in the cluster\u2019s namespace"}),"\n",(0,r.jsx)(t.p,{children:"Create the service account in the cluster's namespace you plan on using as the environment namespace, and associate its IAM role to the IAM role you just created."}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"To create the service account"}),":"]}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Save the following as an ",(0,r.jsx)(t.strong,{children:"SA.yaml"})," file."]}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-jsx",metastring:"title=",children:"apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  annotations:\n    eks.amazonaws.com/role-arn: <enter your role arn here>\n  name: <service account name>\n  namespace: <environment namespace name>  \n2. From AWS CLI, run the following command:\n```jsx title=\nkubectl apply -f SA.yaml\n"})}),"\n",(0,r.jsxs)(t.p,{children:["You're done. All that's left to do is specify the service account name in the blueprint YAML. For details, see ",(0,r.jsx)(t.a,{href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#agent",children:"Agent"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"for-additional-details-see-these-aws-docs",children:"For additional details, see these AWS docs:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Create an IAM OIDC provider for your cluster (",(0,r.jsx)(t.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html",children:"Instructions"}),")."]}),"\n",(0,r.jsxs)(t.li,{children:["Create the IAM role to be used by the service account. (",(0,r.jsx)(t.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/create-service-account-iam-policy-and-role.html",children:"Instructions"}),")."]}),"\n",(0,r.jsxs)(t.li,{children:["Associate the IAM role to a service account on your cluster (",(0,r.jsx)(t.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/specify-service-account-role.html",children:"Instructions\u200B"}),").",(0,r.jsx)(t.br,{}),"\n","If the Terraform resources are to be created in a different AWS account than the one hosting the EKS cluster which is our agent, you'll need to perform steps (1) and (2) on the target account. See ",(0,r.jsx)(t.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html",children:"AWS' Technical overview"}),"."]}),"\n"]})]})}function d(e={}){let{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},4429:function(e,t,s){s.d(t,{R:()=>o,x:()=>c});var n=s(6540);let r={},i=n.createContext(r);function o(e){let t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);