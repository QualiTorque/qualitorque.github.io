"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([["641"],{8835:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>s,toc:()=>c,default:()=>u,metadata:()=>i,assets:()=>l,contentTitle:()=>a});var i=JSON.parse('{"id":"blueprint-designer-guide/blueprints/cloudformation-grain","title":"The CloudFormation Grain","description":"The CloudFormation grain represents Torque\'s native support for AWS CloudFormation templates. Torque enables designers to utilize CloudFormation features for orchestrating both self-developed and community-driven CloudFormation modules in a consistent manner, making them accessible as reusable building blocks.","source":"@site/docs/blueprint-designer-guide/blueprints/cloudformation-grain.md","sourceDirName":"blueprint-designer-guide/blueprints","slug":"/blueprint-designer-guide/blueprints/cloudformation-grain","permalink":"/blueprint-designer-guide/blueprints/cloudformation-grain","draft":false,"unlisted":false,"editUrl":"https://github.com/QualiTorque/torque-docs/tree/master/docs/blueprint-designer-guide/blueprints/cloudformation-grain.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8,"title":"The CloudFormation Grain"},"sidebar":"torqueSidebar","previous":{"title":"The CDK Grain","permalink":"/blueprint-designer-guide/blueprints/cdk-grain"},"next":{"title":"The CloudShell Grain","permalink":"/blueprint-designer-guide/blueprints/cloudshell-grain"}}'),r=t(4848),o=t(4429);let s={sidebar_position:8,title:"The CloudFormation Grain"},a=void 0,l={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Required AWS Policy",id:"required-aws-policy",level:3},{value:"Usage example",id:"usage-example",level:2},{value:"Grain Spec Reference",id:"grain-spec-reference",level:2},{value:"<code>region</code>",id:"region",level:3},{value:"<code>source</code>",id:"source",level:3},{value:"<code>agent</code>",id:"agent",level:3},{value:"<code>authentication</code>",id:"authentication",level:3},{value:"<code>template-storage</code>",id:"template-storage",level:3},{value:"<code>inputs</code>",id:"inputs",level:3},{value:"<code>tags</code>",id:"tags",level:3},{value:"<code>outputs</code>",id:"outputs",level:3},{value:"<code>stack-name-prefix</code>",id:"stack-name-prefix",level:3},{value:"Drift Detection and Reconciliation",id:"drift-detection-and-reconciliation",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"The CloudFormation grain represents Torque's native support for AWS CloudFormation templates. Torque enables designers to utilize CloudFormation features for orchestrating both self-developed and community-driven CloudFormation modules in a consistent manner, making them accessible as reusable building blocks."}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsx)(n.p,{children:"Before utilizing CloudFormation with Torque, ensure that you have the following prerequisites in place:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"S3 bucket"}),": An S3 bucket designated for the temporary storage of large templates (required for templates exceeding 50K bytes)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"AWS policy"}),": Proper AWS permissions for CloudFormation operations"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:'For templates exceeding 50K bytes in size, Torque requires a "template-storage" location to upload templates from a Git repository, enabling the creation of CloudFormation stacks. Templates are fetched from Git and stored in this bucket, from where they can be launched.'}),"\n",(0,r.jsx)(n.h3,{id:"required-aws-policy",children:"Required AWS Policy"}),"\n",(0,r.jsx)(n.p,{children:"To grant Torque the necessary permissions to successfully provision resources, your credentials must include at least the following policy:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Sid": "BasicBucketOperations",\n      "Effect": "Allow",\n      "Action": [\n        "s3:PutObject",\n        "s3:GetObject",\n        "s3:DeleteObject"\n      ],\n      "Resource": [\n        "arn:aws:s3:::<your-bucket>/*"\n      ]\n    },\n    {\n      "Sid": "BasicCfnOperations",\n      "Effect": "Allow",\n      "Action": [\n        "cloudformation:CreateStack",\n        "cloudformation:DeleteStack",\n        "cloudformation:UpdateStack",\n        "cloudformation:DescribeStacks",\n        "cloudformation:DescribeStackEvents"\n      ],\n      "Resource": "*"\n    }\n  ]\n}\n'})}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsx)(n.p,{children:"Include any additional permissions required to launch the resources inside the template. For example, if your template uses EC2, add the appropriate EC2 permissions."})}),"\n",(0,r.jsx)(n.h2,{id:"usage-example",children:"Usage example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"spec_version: 2\ndescription: CloudFormation S3 bucket deployment\n\ninputs:\n  access_control:\n    type: string\n    default: 'Private'\n    allowed-values: ['Private', 'PublicRead', 'PublicReadWrite']\n  bucket_name:\n    type: string\n  agent:\n    type: agent\n\noutputs:\n  bucket_arn:\n    value: '{{ .grains.s3-bucket.outputs.Arn }}'\n  domain_name:\n    value: '{{ .grains.s3-bucket.outputs.DomainName }}'\n\ngrains:\n  s3-bucket:\n    kind: cloudformation\n    spec:\n      source:\n        store: cfn-templates\n        path: storage/s3-bucket.yaml\n      agent:\n        name: '{{ .inputs.agent }}'\n      region: us-east-1\n      authentication:\n        - '{{ .inputs.aws_credentials }}'\n      inputs:\n        - AccessControl: '{{ .inputs.access_control }}'\n        - BucketName: '{{ .inputs.bucket_name }}-{{ sandboxid | downcase }}'\n      outputs:\n        - Arn\n        - DomainName\n"})}),"\n",(0,r.jsx)(n.h2,{id:"grain-spec-reference",children:"Grain Spec Reference"}),"\n",(0,r.jsx)(n.h3,{id:"region",children:(0,r.jsx)(n.code,{children:"region"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"region"})," is a required key in the CloudFormation grain. It defines where the stack will be created."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"grains:\n  my-stack:\n    kind: cloudformation\n    spec:\n      region: us-west-2\n"})}),"\n",(0,r.jsx)(n.h3,{id:"source",children:(0,r.jsx)(n.code,{children:"source"})}),"\n",(0,r.jsxs)(n.p,{children:["Please see ",(0,r.jsx)(n.a,{href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#source",children:"the grain source"})," for more details."]}),"\n",(0,r.jsx)(n.h3,{id:"agent",children:(0,r.jsx)(n.code,{children:"agent"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"agent"})," is now ",(0,r.jsx)(n.strong,{children:"required"})," for CloudFormation Grain. Please see ",(0,r.jsx)(n.a,{href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#agent",children:"the grain agent"})," for more details."]}),"\n",(0,r.jsx)(n.h3,{id:"authentication",children:(0,r.jsx)(n.code,{children:"authentication"})}),"\n",(0,r.jsx)(n.p,{children:"To enable Torque to connect to the AWS account and deploy the CloudFormation template, you have two options:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Torque credentials"}),": Authenticate with AWS access key and secret key OR AWS role ARN to be assumed by Torque"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Service account"}),": Authenticate with a service account that will be attached to the runner which provisions the infrastructure"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example - Option 1 (Torque credentials):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"grains:\n  database:\n    kind: cloudformation\n    spec:\n      source:\n        store: my-repo\n        path: folder/my-cfn.yaml\n      agent: \n        name: my-agent  \n      authentication:\n        - '{{ .inputs.aws_credentials }}'\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example - Option 2 (Service account):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"grains:\n  database:\n    kind: cloudformation\n    spec:\n      source:\n        store: my-repo\n        path: folder/my-cfn.yaml\n      agent:\n        name: my-agent \n        service-account: agent-service-account\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsx)(n.p,{children:"The service account needs to be annotated by an AWS role ARN to be assumed by Torque. If not provided, Torque will try to use the default service account of the agent."})}),"\n",(0,r.jsx)(n.h3,{id:"template-storage",children:(0,r.jsx)(n.code,{children:"template-storage"})}),"\n",(0,r.jsxs)(n.p,{children:["In the ",(0,r.jsx)(n.code,{children:"cloudformation"})," grain, you need to specify the details of the S3 bucket serving as the template-storage for larger templates."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"grains:\n  database:\n    kind: cloudformation\n    spec:\n      source:\n        store: my-repo\n        path: folder/my-app\n      template-storage:\n        bucket-name: 'my-cfn-templates-bucket'\n        region: 'us-east-1'\n        key-prefix: 'templates/'\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"template-storage"})," is optional, but required for templates larger than 50K bytes and when using nested stacks"]}),"\n",(0,r.jsx)(n.li,{children:"Ensure your service account or credentials have permissions to read from the bucket"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"bucket-name"})," and ",(0,r.jsx)(n.code,{children:"region"})," are required and can be templated"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"key-prefix"})," is optional and defines the file path where the template will be located inside the bucket"]}),"\n"]})}),"\n",(0,r.jsx)(n.h3,{id:"inputs",children:(0,r.jsx)(n.code,{children:"inputs"})}),"\n",(0,r.jsxs)(n.p,{children:["Similar to blueprint inputs, CloudFormation grain ",(0,r.jsx)(n.code,{children:"inputs"})," allow you to reuse the same CloudFormation module in different ways. Inputs provided to the CloudFormation grain are used when launching the CloudFormation module."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"grains:\n  database:\n    kind: cloudformation\n    spec:\n      source:\n        store: my-repo\n        path: cloudformation/rds.yaml\n      inputs:\n        - DBInstanceClass: '{{ .inputs.instance_type }}'\n        - DBName: '{{ .inputs.database_name }}'\n        - MasterUsername: '{{ .params.db_username }}'\n"})}),"\n",(0,r.jsx)(n.h3,{id:"tags",children:(0,r.jsx)(n.code,{children:"tags"})}),"\n",(0,r.jsx)(n.p,{children:"Whenever a CloudFormation grain is launched, all resources created during the deployment process are automatically tagged with Torque's system tags, built-in tags and custom tags."}),"\n",(0,r.jsx)(n.h3,{id:"outputs",children:(0,r.jsx)(n.code,{children:"outputs"})}),"\n",(0,r.jsx)(n.p,{children:"Outputs are strings generated by CloudFormation during the deployment process."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"grains:\n  database:\n    kind: cloudformation\n    spec:\n      source:\n        store: my-repo\n        path: cloudformation/database.yaml\n      authentication:\n        - '{{ .inputs.aws_credentials }}'\n      outputs:\n        - DatabaseEndpoint\n        - DatabasePort\n        - ConnectionString\n"})}),"\n",(0,r.jsx)(n.h3,{id:"stack-name-prefix",children:(0,r.jsx)(n.code,{children:"stack-name-prefix"})}),"\n",(0,r.jsx)(n.p,{children:"You can prefix all stacks created by Torque with a customized prefix to adhere to your organization standards or conventions."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"grains:\n  my-stack:\n    kind: cloudformation\n    spec:\n      source:\n        store: my-repo\n        path: cloudformation/stack.yaml\n      stack-name-prefix: 'my-org-'\n      region: us-east-1\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsxs)(n.p,{children:["You can also define a system parameter at the account or space level with the name ",(0,r.jsx)(n.code,{children:"SYSTEM_CFN_STACK_NAME_PREFIX"})," to apply the prefix to all CloudFormation stacks in the account or space."]})}),"\n",(0,r.jsx)(n.h2,{id:"drift-detection-and-reconciliation",children:"Drift Detection and Reconciliation"}),"\n",(0,r.jsx)(n.p,{children:"Resolving drift in AWS CloudFormation involves acknowledging the updated configuration as the intended state and adjusting the stack template accordingly. In Torque, drift resolution or reconciliation entails undoing changes made to cloud resources and restoring them to the original template."}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"Due to AWS limitations, if the drift includes deleted resources, Torque will not be able to restore these via reconciliation. It is advised to reconcile the stack manually via the AWS console or CLI."})})]})}function u(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},4429:function(e,n,t){t.d(n,{R:()=>s,x:()=>a});var i=t(6540);let r={},o=i.createContext(r);function s(e){let n=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);