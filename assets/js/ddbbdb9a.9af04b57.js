"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([["3644"],{9006:function(e,n,s){s.r(n),s.d(n,{frontMatter:()=>a,toc:()=>l,default:()=>p,metadata:()=>t,assets:()=>c,contentTitle:()=>o});var t=JSON.parse('{"id":"blueprint-designer-guide/blueprints/kubernetes-grain","title":"The Kubernetes Grain\u200B","description":"The Kubernetes grain allows you to deploy native Kubernetes manifests and manifest catalogs from your repositories as part of a Torque blueprint. The grain leverages Kubernetes\' declarative approach to manage containerized applications and services within your Torque environments.","source":"@site/docs/blueprint-designer-guide/blueprints/kubernetes-grain.md","sourceDirName":"blueprint-designer-guide/blueprints","slug":"/blueprint-designer-guide/blueprints/kubernetes-grain","permalink":"/blueprint-designer-guide/blueprints/kubernetes-grain","draft":false,"unlisted":false,"editUrl":"https://github.com/QualiTorque/torque-docs/tree/master/docs/blueprint-designer-guide/blueprints/kubernetes-grain.md","tags":[],"version":"current","sidebarPosition":11,"frontMatter":{"sidebar_position":11,"title":"The Kubernetes Grain\u200B"},"sidebar":"defaultSidebar","previous":{"title":"The Helm Grain","permalink":"/blueprint-designer-guide/blueprints/helm-grain"},"next":{"title":"The OpenTofu Grain","permalink":"/blueprint-designer-guide/blueprints/opentofu-grain"}}'),r=s(4848),i=s(4429);let a={sidebar_position:11,title:"The Kubernetes Grain\u200B"},o=void 0,c={},l=[{value:"Tools and technologies",id:"tools-and-technologies",level:2},{value:"Namespace considerations",id:"namespace-considerations",level:2},{value:"Usage example",id:"usage-example",level:2},{value:"Grain Spec Reference",id:"grain-spec-reference",level:2},{value:"<code>source</code>",id:"source",level:3},{value:"<code>agent</code>",id:"agent",level:3},{value:"<code>target-namespace</code>",id:"target-namespace",level:3},{value:"<code>tags</code>",id:"tags",level:3},{value:"<code>scripts</code>",id:"scripts",level:3}];function u(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"The Kubernetes grain allows you to deploy native Kubernetes manifests and manifest catalogs from your repositories as part of a Torque blueprint. The grain leverages Kubernetes' declarative approach to manage containerized applications and services within your Torque environments."}),"\n",(0,r.jsx)(n.h2,{id:"tools-and-technologies",children:"Tools and technologies"}),"\n",(0,r.jsx)(n.p,{children:"The following tools and technologies are installed out of the box on our agents in the Kubernetes pods and can be used when designing Kubernetes deployments:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"dotnet"}),"\n",(0,r.jsx)(n.li,{children:"curl"}),"\n",(0,r.jsx)(n.li,{children:"kubectl"}),"\n",(0,r.jsx)(n.li,{children:"jq"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"namespace-considerations",children:"Namespace considerations"}),"\n",(0,r.jsx)(n.admonition,{title:"Important",type:"warning",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The target namespace must exist in the cluster prior to deployment"}),"\n",(0,r.jsx)(n.li,{children:"The namespace must not be equal to the namespaces used by Torque for agent deployments"}),"\n",(0,r.jsx)(n.li,{children:"Ensure the service account has sufficient permissions to create/read/delete everything in the manifest, including secrets and volumes"}),"\n",(0,r.jsx)(n.li,{children:"Currently, it is not possible to launch multiple concurrent environments from the same blueprint on the same namespace because the manifest resources are static and their names are not unique"}),"\n"]})}),"\n",(0,r.jsx)(n.h2,{id:"usage-example",children:"Usage example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"spec_version: 2\ndescription: Deploy a web application with NGINX and Redis\n\ninputs:\n  agent:\n    type: agent\n  namespace:\n    type: string\n    default: \"web-app\"\n  replicas:\n    type: string\n    default: \"3\"\n\ngrains:\n  web_application:\n    kind: kubernetes\n    spec:\n      source:\n        store: k8s-manifests\n        path: web-app/deployment.yaml\n      target-namespace: '{{ .inputs.namespace }}'\n      agent:\n        name: '{{ .inputs.agent }}'\n        service-account: 'torque-k8s-sa'\n      scripts:\n        post-kubernetes-install:\n          source:\n            store: k8s-scripts\n            path: scripts/get-service-info.sh\n          outputs:\n            - service_url\n            - service_port\n"})}),"\n",(0,r.jsx)(n.h2,{id:"grain-spec-reference",children:"Grain Spec Reference"}),"\n",(0,r.jsx)(n.h3,{id:"source",children:(0,r.jsx)(n.code,{children:"source"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"source"})," section specifies where your Kubernetes manifests are located. This can be a direct path to a manifest file or a reference to a directory containing multiple manifest files."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example - single manifest:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"kubernetes_grain:\n  kind: kubernetes\n  spec:\n    source:\n      store: k8s-repo\n      path: manifests/nginx-deployment.yaml\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example - manifest directory:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"kubernetes_grain:\n  kind: kubernetes\n  spec:\n    source:\n      store: k8s-repo\n      path: manifests/web-app\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Please see ",(0,r.jsx)(n.a,{href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#source",children:"the grain source"})," for more details."]}),"\n",(0,r.jsx)(n.h3,{id:"agent",children:(0,r.jsx)(n.code,{children:"agent"})}),"\n",(0,r.jsx)(n.p,{children:"The agent executing the Kubernetes grain must have access to the target Kubernetes cluster and appropriate permissions to deploy resources in the specified namespace."}),"\n",(0,r.jsxs)(n.p,{children:["Please see ",(0,r.jsx)(n.a,{href:"/blueprint-designer-guide/blueprints/blueprints-yaml-structure#agent",children:"the grain agent"})," for more details."]}),"\n",(0,r.jsx)(n.h3,{id:"target-namespace",children:(0,r.jsx)(n.code,{children:"target-namespace"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"target-namespace"})," field specifies which Kubernetes namespace the manifests will be deployed to. The namespace must exist prior to deployment."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"grains:\n  web_app:\n    kind: kubernetes\n    spec:\n      source:\n        store: k8s-repo\n        path: web-app/\n      target-namespace: '{{ .inputs.namespace }}'\n      agent:\n        name: '{{ .inputs.agent }}'\n        service-account: '{{ .inputs.service_account }}'\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Launching concurrent environments with a Kubernetes grain is not supported for the same namespace"}),"\n",(0,r.jsx)(n.li,{children:"Ensure the Torque agent has permissions to use the target namespace"}),"\n",(0,r.jsx)(n.li,{children:"The namespace must not be equal to namespaces used by Torque for agent deployments"}),"\n"]})}),"\n",(0,r.jsx)(n.h3,{id:"tags",children:(0,r.jsx)(n.code,{children:"tags"})}),"\n",(0,r.jsx)(n.p,{children:"Whenever a Kubernetes grain is launched, all resources created during the deployment process are automatically tagged with Torque's system tags, built-in tags, and custom tags. You can disable auto-tagging for specific grains if needed."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example - disable auto-tagging:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"grains:\n  database:\n    kind: kubernetes\n    spec:\n      source:\n        store: k8s-repo\n        path: database\n      target-namespace: 'database-ns'\n      tags:\n        auto-tag: false\n"})}),"\n",(0,r.jsx)(n.h3,{id:"scripts",children:(0,r.jsx)(n.code,{children:"scripts"})}),"\n",(0,r.jsx)(n.p,{children:"Kubernetes does not natively support outputs from manifest deployments. Using Torque scripts, you can extract information from deployed resources and provide it as grain outputs. Scripts are executed after the grain's installation and must export environment variables that correspond to declared outputs."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Usage example:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"outputs:\n  service_url:\n    kind: regular\n    value: '{{ .grains.nginx.scripts.post-kubernetes-install.outputs.service_url }}'\n  service_port:\n    kind: regular\n    value: '{{ .grains.nginx.scripts.post-kubernetes-install.outputs.service_port }}'\n\ngrains:\n  nginx:\n    kind: kubernetes\n    spec:\n      source:\n        store: k8s-manifests\n        path: nginx/deployment.yaml\n      target-namespace: 'web-services'\n      agent:\n        name: '{{ .inputs.agent }}'\n      scripts:\n        post-kubernetes-install:\n          source:\n            store: k8s-scripts\n            path: scripts/get-service-info.sh\n          outputs:\n            - service_url\n            - service_port\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The script ",(0,r.jsx)(n.code,{children:"get-service-info.sh"})," should export environment variables that match the declared outputs:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"#!/bin/bash\n# Example script to get service information\nSERVICE_URL=$(kubectl get service nginx-service -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')\nSERVICE_PORT=$(kubectl get service nginx-service -o jsonpath='{.spec.ports[0].port}')\n\nexport service_url=\"http://${SERVICE_URL}\"\nexport service_port=\"${SERVICE_PORT}\"\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["Scripts have access to ",(0,r.jsx)(n.code,{children:"kubectl"})," and can query the deployed resources to extract useful information for other grains or blueprint outputs."]})})]})}function p(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},4429:function(e,n,s){s.d(n,{R:()=>a,x:()=>o});var t=s(6540);let r={},i=t.createContext(r);function a(e){let n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);