"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([[3250],{3905:function(e,t,o){o.d(t,{Zo:function(){return u},kt:function(){return d}});var a=o(7294);function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function l(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){n(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function i(e,t){if(null==e)return{};var o,a,n=function(e,t){if(null==e)return{};var o,a,n={},r=Object.keys(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var s=a.createContext({}),c=function(e){var t=a.useContext(s),o=t;return e&&(o="function"==typeof e?e(t):l(l({},t),e)),o},u=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var o=e.components,n=e.mdxType,r=e.originalType,s=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),m=c(o),d=n,k=m["".concat(s,".").concat(d)]||m[d]||p[d]||r;return o?a.createElement(k,l(l({ref:t},u),{},{components:o})):a.createElement(k,l({ref:t},u))}));function d(e,t){var o=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=o.length,l=new Array(r);l[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:n,l[1]=i;for(var c=2;c<r;c++)l[c]=o[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,o)}m.displayName="MDXCreateElement"},9843:function(e,t,o){o.r(t),o.d(t,{assets:function(){return u},contentTitle:function(){return s},default:function(){return d},frontMatter:function(){return i},metadata:function(){return c},toc:function(){return p}});var a=o(7462),n=o(3366),r=(o(7294),o(3905)),l=["components"],i={sidebar_position:5,title:"Cost"},s=void 0,c={unversionedId:"admin-guide/cost",id:"admin-guide/cost",title:"Cost",description:"Torque's Cost dashboard provides you with actionable insights into the costs of your space's environments. Cost data is collected using a toque_environment_id tag that is assigned (with a unique value) to every new environment's resources.",source:"@site/docs/admin-guide/cost.md",sourceDirName:"admin-guide",slug:"/admin-guide/cost",permalink:"/admin-guide/cost",editUrl:"https://github.com/QualiTorque/torque-docs/tree/master/docs/admin-guide/cost.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,title:"Cost"},sidebar:"torqueSidebar",previous:{title:"Roles and Permissions",permalink:"/admin-guide/roles-and-permissions"},next:{title:"Notifications",permalink:"/admin-guide/notifications"}},u={},p=[{value:"Supported cloud providers",id:"supported-cloud-providers",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Accuracy and incurred costs",id:"accuracy-and-incurred-costs",level:2},{value:"KubeCost deployment",id:"kubecost-deployment",level:2},{value:"AWS Cost setup",id:"aws-cost-setup",level:2},{value:"Azure Cost setup",id:"azure-cost-setup",level:2}],m={toc:p};function d(e){var t=e.components,i=(0,n.Z)(e,l);return(0,r.kt)("wrapper",(0,a.Z)({},m,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Torque's ",(0,r.kt)("strong",{parentName:"p"},"Cost")," dashboard provides you with actionable insights into the costs of your space's environments. Cost data is collected using a ",(0,r.kt)("strong",{parentName:"p"},"toque_environment_id")," tag that is assigned (with a unique value) to every new environment's resources."),(0,r.kt)("h2",{id:"supported-cloud-providers"},"Supported cloud providers"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"AWS"),(0,r.kt)("li",{parentName:"ul"},"Azure"),(0,r.kt)("li",{parentName:"ul"},"Kubernetes (EKS/AKS)")),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"IAM user that has access to billing data. For details, see this official AWS help page: ",(0,r.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_billing.html?icmpid=docs_iam_console#tutorial-billing-step1"},"IAM tutorial: Delegate access to the billing console"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#aws-cost-setup"},"AWS Cost setup")," / ",(0,r.kt)("a",{parentName:"li",href:"#azure-cost-setup"},"Azure Cost setup")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"External Id"),": To grant Cost Collection permission to Torque, use the AssumeRole API. ",(0,r.kt)("strong",{parentName:"li"},"External Id")," is one of the parameters of the AssumeRole API that can be used to delegate access from your account to Torque. The combination of this value and the ARN key ensure that only Torque can access the role. "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"ARN key"),": Make sure the ARN role includes a cost exploration permission.\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"How to get External ID and ARN Role:")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Sign in to the AWS Management Console and open the IAM console at ",(0,r.kt)("a",{parentName:"li",href:"https://console.aws.amazon.com/iam/"},"https://console.aws.amazon.com/iam/"),"."),(0,r.kt)("li",{parentName:"ol"},"In the navigation pane of the IAM console, select ",(0,r.kt)("strong",{parentName:"li"},"Roles"),", and then click ",(0,r.kt)("strong",{parentName:"li"},"Create role"),"."),(0,r.kt)("li",{parentName:"ol"},"From ",(0,r.kt)("strong",{parentName:"li"},"Select trusted entity"),", choose ",(0,r.kt)("strong",{parentName:"li"},"AWS service"),"."),(0,r.kt)("li",{parentName:"ol"},"Select ",(0,r.kt)("strong",{parentName:"li"},"Require external ID"),"."),(0,r.kt)("li",{parentName:"ol"},"Enter an ",(0,r.kt)("strong",{parentName:"li"},"External ID")," of your choosing. The External Id will be used to validate the Consumer of the ARN Role."),(0,r.kt)("li",{parentName:"ol"},"In ",(0,r.kt)("strong",{parentName:"li"},"Next:Permissions"),", select ",(0,r.kt)("strong",{parentName:"li"},"aws-portal:ViewBilling")," for cost exploration permission."),(0,r.kt)("li",{parentName:"ol"},"Click ",(0,r.kt)("strong",{parentName:"li"},"Next"),"."),(0,r.kt)("li",{parentName:"ol"},"Enter a ",(0,r.kt)("strong",{parentName:"li"},"Role Rame")," or role name suffix to help you identify the purpose of this role or use AWS defined Name."),(0,r.kt)("li",{parentName:"ol"},"Click ",(0,r.kt)("strong",{parentName:"li"},"Create Role"),"."),(0,r.kt)("li",{parentName:"ol"},"(Optional) Enter a ",(0,r.kt)("strong",{parentName:"li"},"Description")," for the new role."),(0,r.kt)("li",{parentName:"ol"},"Review the role and then click ",(0,r.kt)("strong",{parentName:"li"},"Create role"),".")),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"Torque collects cost data using cost collection targets, which are managed in the ",(0,r.kt)("strong",{parentName:"p"},"Administration")," page's ",(0,r.kt)("strong",{parentName:"p"},"Cost")," page."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Torque automatically creates a cost collection target for every Kubernetes execution host. The admin needs to enable the cost collection target so Torque can begin collecting cost data. However, Torque collects cost data directly from the pods using a 3",(0,r.kt)("sup",null,"rd"),"-party tool called Kubecost, which must be ",(0,r.kt)("a",{parentName:"li",href:"https://www.kubecost.com/install.html#show-instructions"},"installed on clusters")," you wish to monitor."),(0,r.kt)("li",{parentName:"ul"},"For grains deploying directly on AWS (such as CloudFormation), you need to manually create a cost collection target. By nature, CloudFormation grains are deployed directly on the AWS cloud account and therefore don't require the use of a Kubernetes execution host.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"To enable a cost collection target:")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Go to ",(0,r.kt)("strong",{parentName:"li"},"Administration > Cloud Accounts > Cost Collection Target"),"."),(0,r.kt)("li",{parentName:"ol"},"Click the desired cost collection target's ",(0,r.kt)("strong",{parentName:"li"},"Enabled")," toggle.",(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("img",{alt:"Locale Dropdown",src:o(6280).Z,width:"1122",height:"420"}))))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"To create a cost collection target:")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Go to ",(0,r.kt)("strong",{parentName:"li"},"Administration > Cloud Accounts > Cost Collection Target"),"."),(0,r.kt)("li",{parentName:"ol"},"Click ",(0,r.kt)("strong",{parentName:"li"},"Add Cost Collection Target"),"."),(0,r.kt)("li",{parentName:"ol"},"Select the cloud account."),(0,r.kt)("li",{parentName:"ol"},"Specify the cloud account's details (see ",(0,r.kt)("a",{parentName:"li",href:"#prerequisites"},"Prerequisites"),"):",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"External Id")," "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"ARN key")))),(0,r.kt)("li",{parentName:"ol"},"Click ",(0,r.kt)("strong",{parentName:"li"},"Finish"),"."),(0,r.kt)("li",{parentName:"ol"},"Click the cost collection target's 3 dot menu and select ",(0,r.kt)("strong",{parentName:"li"},"Validate")," to make sure it works (i.e. cost data can be collected).",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"If validation fails, see ",(0,r.kt)("a",{parentName:"li",href:"#kubecost-deployment"},"KubeCost deployment"),".   ")))),(0,r.kt)("h2",{id:"accuracy-and-incurred-costs"},"Accuracy and incurred costs"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"For CloudFormation grains, which are deployed directly on the cloud account, Torque syncs cost data once a day at 3:00 AM UTC time against the cloud provider."),(0,r.kt)("li",{parentName:"ul"},"For all other grains, Torque collects the data from Kubecost on an hourly basis.")),(0,r.kt)("p",null,"Torque calls your cloud provider's API to query the cost. This operation might incur additional charges from your cloud provider."),(0,r.kt)("h2",{id:"kubecost-deployment"},"KubeCost deployment"),(0,r.kt)("p",null,"K8S cost data is collected by Torque using Kubecost. Please perform this procedure if your Cost Collection Target failed validation."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Verify that Kubecost is deployed in the cluster.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"For deployment instructions, see: ",(0,r.kt)("a",{parentName:"li",href:"https://www.kubecost.com/install.html#show-instructions"},"https://www.kubecost.com/install.html#show-instructions")),(0,r.kt)("li",{parentName:"ul"},"Make sure the kubecost default namespace is used (Namespace kubecost)"))),(0,r.kt)("li",{parentName:"ol"},"In Torque, try to re-enable the K8S cost collection target and validate that it works."),(0,r.kt)("li",{parentName:"ol"},"If the error still exists, run the ",(0,r.kt)("inlineCode",{parentName:"li"},"Get agent deployment file")," API call with the following body: ",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},'{\n    "service_type": "k8s",\n    "service_name": "[the name of the execution host using the k8s agent]",\n    "details": {\n        "include_agent_deployment": false,\n        "enable_kubecost": true\n    }\n}\n'))),(0,r.kt)("li",{parentName:"ol"},"Save the output to a deployment file."),(0,r.kt)("li",{parentName:"ol"},"Run the following command on the cluster:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"kubectl apply -f \u201c[generated deployment file]\u201d\n"))),(0,r.kt)("li",{parentName:"ol"},"Try to re-validate the cost collection target."),(0,r.kt)("li",{parentName:"ol"},"If the error still exists, call Torque support.")),(0,r.kt)("h2",{id:"aws-cost-setup"},"AWS Cost setup"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"To enable billing retrieval via the IAM user:")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"In AWS, login as your root user."),(0,r.kt)("li",{parentName:"ol"},"In the top toolbar, click your ",(0,r.kt)("strong",{parentName:"li"},"username")," and then select ",(0,r.kt)("strong",{parentName:"li"},"My Account"),"."),(0,r.kt)("li",{parentName:"ol"},"Select the ",(0,r.kt)("strong",{parentName:"li"},"IAM User & Role Access to Billing Information")," checkbox.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"To verify your IAM user has access to Billing:")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"In AWS, login as your root user."),(0,r.kt)("li",{parentName:"ol"},"In the top toolbar, select ",(0,r.kt)("strong",{parentName:"li"},"Services"),". "),(0,r.kt)("li",{parentName:"ol"},"Search for ",(0,r.kt)("strong",{parentName:"li"},"Billing")," and select it from the result list.\nThe ",(0,r.kt)("strong",{parentName:"li"},"Billing and Cost Management Dashboard")," displays.")),(0,r.kt)("p",null,"If you do not have access to the dashboard, follow these steps:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"In AWS, login as your root user."),(0,r.kt)("li",{parentName:"ol"},"From the top toolbar, select ",(0,r.kt)("strong",{parentName:"li"},"Services"),"."),(0,r.kt)("li",{parentName:"ol"},"Select ",(0,r.kt)("strong",{parentName:"li"},"IAM"),"."),(0,r.kt)("li",{parentName:"ol"},"From the left toolbar, select ",(0,r.kt)("strong",{parentName:"li"},"Users")," and select the ",(0,r.kt)("strong",{parentName:"li"},"IAM user")," requiring the service permission."),(0,r.kt)("li",{parentName:"ol"},"Select ",(0,r.kt)("strong",{parentName:"li"},"Add Permissions"),"."),(0,r.kt)("li",{parentName:"ol"},"Select ",(0,r.kt)("strong",{parentName:"li"},"Attach existing policies directly"),"."),(0,r.kt)("li",{parentName:"ol"},"Search for ",(0,r.kt)("strong",{parentName:"li"},"PowerUserAccess")," and ",(0,r.kt)("strong",{parentName:"li"},"Add")," the policy to the IAM user.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"To configure Torque\u2019s Cost Allocation Tags:"),"\nNote: In order to see the tags noted in the steps below, first launch a sandbox via Torque."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"In AWS, login as the ",(0,r.kt)("strong",{parentName:"li"},"IAM user")," role name."),(0,r.kt)("li",{parentName:"ol"},"In the top toolbar, select ",(0,r.kt)("strong",{parentName:"li"},"Services"),"."),(0,r.kt)("li",{parentName:"ol"},"Search for ",(0,r.kt)("strong",{parentName:"li"},"Billing")," and select it from the result list. This was enabled during the previous steps."),(0,r.kt)("li",{parentName:"ol"},"Select ",(0,r.kt)("strong",{parentName:"li"},"Cost Allocation Tags"),"."),(0,r.kt)("li",{parentName:"ol"},"Search for the following tags: ",(0,r.kt)("strong",{parentName:"li"},"torque-blueprint-name"),", ",(0,r.kt)("strong",{parentName:"li"},"torque-cloud-account-id"),", ",(0,r.kt)("strong",{parentName:"li"},"torque-environment-id"),"."),(0,r.kt)("li",{parentName:"ol"},"Select the box to the left of each tag and select ",(0,r.kt)("strong",{parentName:"li"},"Activate"),".")),(0,r.kt)("p",null,"Note: Torque will begin to pull the data via the API and aggregate the information. Learn more about ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/custom-tags.html"},"AWS User-Defined Costs"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"To validate the setup:")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Wait at least 24 hours after configuration and then log in to your Torque account."),(0,r.kt)("li",{parentName:"ol"},"Select ",(0,r.kt)("strong",{parentName:"li"},"Cost")," to see your values. The data will show you the costs for the last 24 hours."),(0,r.kt)("li",{parentName:"ol"},"If there are any errors, begin troubleshooting this procedure.")),(0,r.kt)("h2",{id:"azure-cost-setup"},"Azure Cost setup"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"To setup cost tracking in your Azure account:")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Log in to your Azure account."),(0,r.kt)("li",{parentName:"ol"},"Select ",(0,r.kt)("strong",{parentName:"li"},"Subscriptions")," and open the subscription that Torque is using."),(0,r.kt)("li",{parentName:"ol"},"Select ",(0,r.kt)("strong",{parentName:"li"},"Cost analysis")," from the subscription menu."),(0,r.kt)("li",{parentName:"ol"},"Make sure you can see cost information. If not, contact Azure's support and configure your access to cost information."),(0,r.kt)("li",{parentName:"ol"},"Wait at least 24 hours after configuration and then log in to your Torque account."),(0,r.kt)("li",{parentName:"ol"},"Select ",(0,r.kt)("strong",{parentName:"li"},"Cost")," to see your values. The data will show you the costs for the last 24 hours."),(0,r.kt)("li",{parentName:"ol"},"If there are any errors, begin troubleshooting this procedure.")))}d.isMDXComponent=!0},6280:function(e,t,o){t.Z=o.p+"assets/images/enable-cost-target-eea58f1186ba7c84fa9ad4c19b937f70.png"}}]);