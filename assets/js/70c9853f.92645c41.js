"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([[405],{3905:function(e,t,r){r.d(t,{Zo:function(){return u},kt:function(){return m}});var n=r(7294);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var c=n.createContext({}),l=function(e){var t=n.useContext(c),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},u=function(e){var t=l(e.components);return n.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,o=e.mdxType,a=e.originalType,c=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=l(r),m=o,h=d["".concat(c,".").concat(m)]||d[m]||p[m]||a;return r?n.createElement(h,i(i({ref:t},u),{},{components:r})):n.createElement(h,i({ref:t},u))}));function m(e,t){var r=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=r.length,i=new Array(a);i[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var l=2;l<a;l++)i[l]=r[l];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"},7972:function(e,t,r){r.r(t),r.d(t,{assets:function(){return u},contentTitle:function(){return c},default:function(){return m},frontMatter:function(){return s},metadata:function(){return l},toc:function(){return p}});var n=r(7462),o=r(3366),a=(r(7294),r(3905)),i=["components"],s={sidebar_position:6,title:"Service Accounts"},c=void 0,l={unversionedId:"blueprint-designer-guide/Service Accounts",id:"blueprint-designer-guide/Service Accounts",title:"Service Accounts",description:"A kubernetes service account provides an identity for processes that run in a pod. We recommend using service accounts if you are using a Kubernetes cluster as your execution host.",source:"@site/docs/blueprint-designer-guide/Service Accounts.md",sourceDirName:"blueprint-designer-guide",slug:"/blueprint-designer-guide/Service Accounts",permalink:"/blueprint-designer-guide/Service Accounts",editUrl:"https://github.com/QualiTorque/torque-docs/tree/master/docs/blueprint-designer-guide/Service Accounts.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6,title:"Service Accounts"},sidebar:"torqueSidebar",previous:{title:"Autogenerated Blueprints",permalink:"/blueprint-designer-guide/Autogenerated Blueprints"},next:{title:"Blueprint YAML",permalink:"/blueprint-designer-guide/blueprints"}},u={},p=[{value:"Helm charts",id:"helm-charts",level:2},{value:"Terraform modules",id:"terraform-modules",level:2},{value:"Service account configuration for AWS",id:"service-account-configuration-for-aws",level:3},{value:"Associate your cluster to the AWS account",id:"associate-your-cluster-to-the-aws-account",level:3},{value:"Create an IAM role for the service account with the required policy",id:"create-an-iam-role-for-the-service-account-with-the-required-policy",level:3},{value:"For additional details, see these AWS docs:",id:"for-additional-details-see-these-aws-docs",level:4}],d={toc:p};function m(e){var t=e.components,r=(0,o.Z)(e,i);return(0,a.kt)("wrapper",(0,n.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"A kubernetes service account provides an identity for processes that run in a pod. We recommend using service accounts if you are using a Kubernetes cluster as your execution host.\nThe service account is specified in the ",(0,a.kt)("strong",{parentName:"p"},"grains")," section of the blueprint, in the ",(0,a.kt)("strong",{parentName:"p"},"hosts")," node:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="Blueprint yaml:"',title:'"Blueprint','yaml:"':!0},"...\ngrains:\n  my-grain-name:\n    kind : terraform \n    spec:\n      ...\n      host:\n        name : <execution-host-name>\n        service-account : <service-account-name>\n      ...\n")),(0,a.kt)("h2",{id:"helm-charts"},"Helm charts"),(0,a.kt)("p",null,"When you're deploying resources in the cluster using a Helm chart, the service account you use should have sufficient permissions to create all the resources which the chart will deploy. For details, see ",(0,a.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions"},"Kubernetes' ServiceAccount permissions")),(0,a.kt)("h2",{id:"terraform-modules"},"Terraform modules"),(0,a.kt)("h3",{id:"service-account-configuration-for-aws"},"Service account configuration for AWS"),(0,a.kt)("p",null,"If you're using an EKS cluster as your execution host, and you want to deploy resources to an AWS account, you can use service account to do the authentication and permissions between the pod and the AWS account where the resources will be created. This is done by connecting a service account, which contains these permissions, to the container. The permissions are defined in an IAM role that needs to be associated to the service account."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Prerequisites")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"IAM OIDC provider on the cluster\u2019s account, to recognize the cluster on the account"),(0,a.kt)("li",{parentName:"ul"},"kubectl on the cluster"),(0,a.kt)("li",{parentName:"ul"},"AWS CLI on your computer")),(0,a.kt)("h3",{id:"associate-your-cluster-to-the-aws-account"},"Associate your cluster to the AWS account"),(0,a.kt)("p",null,"Make sure to perform the following steps on every AWS account in which the cluster will perform actions."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"To associate the cluster to the account"),":"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"In AWS CLI, find the cluster\u2019s OIDC provider by running:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},'aws eks describe-cluster --name my-cluster --query "cluster.identity.oidc.issuer" --output text\n')),(0,a.kt)("p",{parentName:"li"},"The output looks something like this:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"https://oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE\n")),(0,a.kt)("p",{parentName:"li"},"Where ",(0,a.kt)("strong",{parentName:"p"},"EXAMPLED539D4633E53DE1B71EXAMPLE")," is the cluster's OIDC provider")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"On the account to be used by the cluster, list an IAM OIDC provider in the account that is associated to the cluster\u2019s OIDC provider:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"aws iam list-open-id-connect-providers | grep my-cluster-oidc-provider\n")),(0,a.kt)("p",{parentName:"li"},"The IAM OIDC provider is displayed:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},'"Arn": "arn:aws:iam::111122223333:oidc-provider/oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE"\n'))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"If the IAM OIDC provider is nonexistent, do the following to create it:"),(0,a.kt)("p",{parentName:"li"},"a.\tInstall ",(0,a.kt)("strong",{parentName:"p"},"eksctl")," on your computer."),(0,a.kt)("p",{parentName:"li"},"b.\tRun the following to create the IAM OIDC provider and associate it to your cluster:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"eksctl utils associate-iam-oidc-provider --cluster my-cluster \u2013approve\n")),(0,a.kt)("p",{parentName:"li"},"c.\tIn AWS CLI, run the following to get the IAM OIDC provider you created:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-jsx",metastring:"title=",title:""},"aws iam list-open-id-connect-providers | grep my-cluster-oidc-provider\n")))),(0,a.kt)("h3",{id:"create-an-iam-role-for-the-service-account-with-the-required-policy"},"Create an IAM role for the service account with the required policy"),(0,a.kt)("p",null,"As we explained before, the service account delegates permissions to the container to perform the Terraform actions. The permissions are defined as a policy in an IAM role that is associated to the service account.\nPerform these steps on every account that will be used by your cluster."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Prerequisites:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"IAM policy with the desired permissions")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"To create the IAM role for the service account"),":"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"In your AWS Console, go to IAM > Role."),(0,a.kt)("li",{parentName:"ol"},"Click Create role, select Web identity."),(0,a.kt)("li",{parentName:"ol"},"From the Identity provider dropdown list, select your cluster\u2019s OIDC provider."),(0,a.kt)("li",{parentName:"ol"},"From the Audience dropdown list, select sts.amazonaws.com."),(0,a.kt)("li",{parentName:"ol"},"Click Next."),(0,a.kt)("li",{parentName:"ol"},"Select the IAM policy you wish to associate to the IAM role, and click Next."),(0,a.kt)("li",{parentName:"ol"},"Specify a Role name."),(0,a.kt)("li",{parentName:"ol"},"Scroll down and click Create role."),(0,a.kt)("li",{parentName:"ol"},"Get the ARN for this role.")),(0,a.kt)("h4",{id:"for-additional-details-see-these-aws-docs"},"For additional details, see these AWS docs:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Create an IAM OIDC provider for your cluster (",(0,a.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html"},"Instructions"),")."),(0,a.kt)("li",{parentName:"ol"},"Create the IAM role to be used by the service account. (",(0,a.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/create-service-account-iam-policy-and-role.html"},"Instructions"),")."),(0,a.kt)("li",{parentName:"ol"},"Associate the IAM role to a service account on your cluster (",(0,a.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/specify-service-account-role.html"},"Instructions\u200b"),").",(0,a.kt)("br",{parentName:"li"}),"If the Terraform resources are to be created in a different AWS account than the one hosting the EKS cluster which is our execution host, you'll need to perform steps (1) and (2) on the target account. See ",(0,a.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html"},"AWS' Technical overview"),".")))}m.isMDXComponent=!0}}]);