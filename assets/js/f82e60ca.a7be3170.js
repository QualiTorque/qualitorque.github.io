"use strict";(self.webpackChunktorque=self.webpackChunktorque||[]).push([["4197"],{2e3:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>i,toc:()=>l,default:()=>d,metadata:()=>s,assets:()=>a,contentTitle:()=>c});var s=JSON.parse('{"id":"torque-agent/Install-and-connect-self-hosted-agent","title":"Install an Agent on your Kubernetes Cluster","description":"Prerequisites","source":"@site/docs/torque-agent/Install-and-connect-self-hosted-agent.md","sourceDirName":"torque-agent","slug":"/torque-agent/Install-and-connect-self-hosted-agent","permalink":"/torque-agent/Install-and-connect-self-hosted-agent","draft":false,"unlisted":false,"editUrl":"https://github.com/QualiTorque/torque-docs/tree/master/docs/torque-agent/Install-and-connect-self-hosted-agent.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Install an Agent on your Kubernetes Cluster"},"sidebar":"torqueSidebar","previous":{"title":"What is the Torque Agent?","permalink":"/torque-agent/Torque-Agent-Intro"},"next":{"title":"Terraform EKS/AWS Authentication","permalink":"/torque-agent/service-accounts-for-aws"}}'),r=t(4848),o=t(4429);let i={sidebar_position:2,title:"Install an Agent on your Kubernetes Cluster"},c=void 0,a={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Setup",id:"setup",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}];function u(e){let n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Kuberentes cluster - can be any cluster, including on your on-premise network. Please note that Torque ",(0,r.jsx)(n.strong,{children:"does not support"})," cluster nodes on ARM architecture."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"/torque-agent/torque-outbound-ports",children:"Outbound Ports for Kubernetes Cluster Nodes"})," must be open to allow Torque to access and communicate with the cluster."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Command-line with ",(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tools/#kubectl",children:"kubectl installed"})," connected to your cluster.\nTo connect to the cluster use:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"kubectl config use-context <your-cluster>\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For further reading on connecting to clusters hosted on your cloud, check these links: ",(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html",children:"EKS"}),", ",(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az-aks-get-credentials",children:"AKS"}),", ",(0,r.jsx)(n.a,{href:"https://cloud.google.com/sdk/gcloud/reference/container/clusters/get-credentials",children:"GKE"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"One or more target namespaces on the cluster where the Torque agent will create resources."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Authentication and permissions - The agent will need sufficient permissions to create the environment's cloud resources. There are a couple of ways to provide the permissions, depending on where the environment resources will be created."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"To create K8s resources (Pods, services, secrets... etc.) using K8s manifests or helm charts, create a service account with sufficient permissions to create the K8s resources.\nFor Example:"}),"\n",(0,r.jsx)(n.p,{children:'Let\'s say that you would like to deploy your environments into a namespace called "my-ns".\nUse the below commands (change to your real namespace name) to create the appropriate service-account:'}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"kubectl create serviceaccount my-ns-edit-sa --namespace=my-ns\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"kubectl create rolebinding my-sa-edit-rb --clusterrole=edit --serviceaccount=my-ns:my-ns-edit-sa --namespace=my-ns\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"To create resources on your cloud using Terraform:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["If your cluster is an ",(0,r.jsx)(n.strong,{children:"EKS"})," (resources will be created on AWS):","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["(Recommended) Create a designated ",(0,r.jsx)(n.strong,{children:"service account"})," annotated with an AWS role. See ",(0,r.jsx)(n.a,{href:"/torque-agent/service-accounts-for-aws",children:"Terraform Authentication on EKS"})," for details. Or,"]}),"\n",(0,r.jsx)(n.li,{children:"Ensure that the Cluster service role has sufficient permissions to create the environment."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["If your cluster is an ",(0,r.jsx)(n.strong,{children:"AKS"})," (resources will be created on Azure): Provide the account's authentication credentials when creating the agent in Torque. For details, see ",(0,r.jsx)(n.a,{href:"/torque-agent/service-accounts-for-azure",children:"Terraform Authentication on AKS"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["If your cluster is a ",(0,r.jsx)(n.strong,{children:"GKE"})," (resources will be created on GCP), see ",(0,r.jsx)(n.a,{href:"/torque-agent/service-accounts-for-gcp",children:"Terraform GKE Authentication"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"For other types of clusters, or if you want to connect to your AWS/Azure with your basic credentials, there is no built-in authentication with Torque so there are no pre-requisites related to authentication and permissions. You can store your cloud credentials in the Torque secret store and use them for your TF deployment."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["In Torque's ",(0,r.jsx)(n.strong,{children:"Administration"})," page, open the ",(0,r.jsx)(n.strong,{children:"Cloud Accounts"})," tab."]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Connect a Cloud"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Select the cloud provider and the type of Kubernetes to use, and give the agent a name.","\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Locale Dropdown",src:t(5730).A+"",width:"923",height:"685"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Next"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Generate"})," and copy the command that is displayed"]}),"\n",(0,r.jsxs)(n.li,{children:["Paste the command in your command-line window to deploy the agent to your cluster. For example:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"kubectl apply -f https://portal.qtorque.io/api/settings/executionhosts/deployment/k***roi/deployment.yaml\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["A ",(0,r.jsx)(n.strong,{children:"Connected!"})," status is displayed in Torque, indicating that the agent was successfully installed and can communicate with Torque.","\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Locale Dropdown",src:t(52).A+"",width:"923",height:"687"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Click ",(0,r.jsx)(n.strong,{children:"Associate to Space"})," to connect the host to a space, and provide the details you obtained in the prerequisites section."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.p,{children:"If the agent fails to connect with Torque, you can try the following to identify the problem."}),"\n",(0,r.jsx)(n.p,{children:'Replace the "agent-namespace" with your agent\'s namespace. You can find it in:'}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.em,{children:"Administration --\x3e Agents --\x3e Identify your agent --\x3e Click on the 3 dots menu --\x3e Edit Agent --\x3e Advanced K8s settings:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Make sure the agent pod is running and healthy. You can run the following command on your cluster:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"kubectl get pods -n <agent-namespace> -l app=torque-agent\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Make sure outbound http connection to Torque is open:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"kubectl exec -it $(kubectl get pods -n <agent-namespace> | grep torque-agent | awk '/'$2'/ {print $1;exit}') -n <agent-namespace> -- /bin/sh -c \"curl -v http://portal.qtorque.io/hub/agent\";\n"})}),"\n","and also","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"kubectl exec -it $(kubectl get pods -n <agent-namespace> | grep torque-agent | awk '/'$2'/ {print $1;exit}') -n <agent-namespace> -- /bin/sh -c \"nmap -p 5671 acrobatic-lime-gerbil.rmq3.cloudamqp.com\";\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Check the agent pod logs. You can run the following command:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-jsx",metastring:"title=",children:"kubectl logs $(kubectl get pods -n <agent-namespace> | grep torque-agent | awk '/'$2'/ {print $1;exit}') -n <agent-namespace>\n"})}),"\n"]}),"\n"]})]})}function d(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},5730:function(e,n,t){t.d(n,{A:()=>s});let s=t.p+"assets/images/add-k8s-wizard-d567de517b79db5fb61ae1c82dd83a90.png"},52:function(e,n,t){t.d(n,{A:()=>s});let s=t.p+"assets/images/agent-connected-status-897afefab061acbb528751b37226e876.png"},4429:function(e,n,t){t.d(n,{R:()=>i,x:()=>c});var s=t(6540);let r={},o=s.createContext(r);function i(e){let n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);